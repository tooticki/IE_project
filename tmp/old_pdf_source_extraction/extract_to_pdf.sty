\RequirePackage{environ}
\RequirePackage{amsgen}
\RequirePackage{etextools}
\RequirePackage[active,tightpage]{preview}

\AtBeginDocument{
  \newwrite\extractedfile
  \immediate\openout\extractedfile=propositions.txt
}

\newcounter{propcounter}

% To remove \hbox in output
\def\@setref#1#2#3{%
  \ifx#1\relax
   \protect\G@refundefinedtrue
   \nfss@text{\reset@font\bfseries ??}%
   \@latex@warning{Reference `#3' on page \thepage \space
             undefined}%
  \else
   \expandafter#2#1
  \fi}

\let\oldnewtheorem\newtheorem
\def\newtheorem{\@ifstar\newtheoremstar\newtheoremnostar}
\def\newtheoremstar#1#2{%
  \oldnewtheorem*{#1}{#2}%
  \definemytheorem{#1}{#2}%
}
\newcommand\newtheoremnostar[1]{%
  \@oparg{\newtheoremnostarinternal{#1}}[]%
}
\def\newtheoremnostarinternal#1[#2]#3{%
  \@oparg{\newtheoremnostartrue{#1}[#2]{#3}}[]%
}
\def\newtheoremnostartrue#1[#2]#3[#4]{%
  \ifx\relax#4\relax
    \oldnewtheorem{#1}[#2]{#3}%
  \else
    \oldnewtheorem{#1}{#3}[#4]%
  \fi
  \definemytheorem{#1}{#3}%
}

\newsavebox{\mybox}
    
\newcommand{\definemytheorem}[2]{%
  \expandafter\let\expandafter\temp\csname #1\endcsname
  \expandafter\global\expandafter\let\csname old#1\endcsname\temp

  \expandafter\let\expandafter\temp\csname end#1\endcsname
  \expandafter\global\expandafter\let\csname oldend#1\endcsname\temp

  \expandafter\let\csname #1\endcsname\undefined
  \expandafter\let\csname end#1\endcsname\undefined

  \NewEnviron{#1}{%
    \addtocounter{propcounter}{1}%
    \savebox{\mybox}{\parbox{\linewidth}{*** \begin{old#1}\label{propcounter@\roman{propcounter}}\BODY\end{old#1}}}%
    \usebox{\mybox}%
    \begin{preview}\usebox{\mybox}\end{preview}%

    \immediate\write\extractedfile{%
      BEGIN #2 \ref{propcounter@\roman{propcounter}}
    ^^J
      \unexpanded\expandafter{\BODY}%
      ^^JEND #2^^J
    }
  }
}

\let\oldproof\proof
\let\oldendproof\endproof
\let\proof\undefined
\let\endproof\undefined

\NewEnviron{proof}{
  \addtocounter{propcounter}{1}
  \begin{oldproof}\label{propcounter@\roman{propcounter}}\BODY\end{oldproof}%

  \immediate\write\extractedfile{%
    BEGIN PROOF
    ^^J
    \unexpanded\expandafter{\BODY}%
    ^^JEND PROOF^^J
  }
}
