%TODO: handle number of theorems, copy the preambule

\RequirePackage{environ}

\AtBeginDocument{
  \newwrite\extractedfile
  \immediate\openout\extractedfile=propositions.tex
}

\newcounter{propcounter}

\def\@setref#1#2#3{%
  \ifx#1\relax
   \protect\G@refundefinedtrue
   \nfss@text{\reset@font\bfseries ??}%
   \@latex@warning{Reference `#3' on page \thepage \space
             undefined}%
  \else
   \expandafter#2#1
  \fi}

\let\oldproposition\proposition
\let\oldendproposition\endproposition
\let\proposition\undefined
\let\endproposition\undefined

\NewEnviron{proposition}{
  \addtocounter{propcounter}{1}
  \begin{oldproposition}\label{propcounter@\roman{propcounter}}\BODY\end{oldproposition}%

  \immediate\write\extractedfile{%
    \unexpanded\expandafter{\@percentchar}
    ============ PROPOSITION 
    % \ref{propcounter@\roman{propcounter}} AAAAA! Why it doesn't work
    ============^^J
    \unexpanded\expandafter\relax{\begin{proposition}} %add relax to use compact form
    ^^J
    \unexpanded\expandafter{\BODY}%
    ^^J
    \unexpanded\expandafter\relax{\end{proposition}}
    ^^J
  }
}


\let\oldtheorem\theorem
\let\oldendtheorem\endtheorem
\let\theorem\undefined
\let\endtheorem\undefined

\NewEnviron{theorem}{
  \addtocounter{propcounter}{1}
  \begin{oldtheorem}\label{propcounter@\roman{propcounter}}\BODY\end{oldtheorem}%

  \immediate\write\extractedfile{%
    \unexpanded\expandafter{\@percentchar}
    ============ THEOREM 
    %\ref{propcounter@\roman{propcounter}}
    ============^^J
    \unexpanded\expandafter\relax{\begin{theorem}} %add relax to use compact form
    ^^J
    \unexpanded\expandafter{\BODY}
    ^^J
    \unexpanded\expandafter\relax{\end{theorem}}
    ^^J
  }
}

\let\oldproof\proof
\let\oldendproof\endproof
\let\proof\undefined
\let\endproof\undefined

\NewEnviron{proof}{
  \addtocounter{propcounter}{1}
  \begin{oldproof}\label{propcounter@\roman{propcounter}}\BODY\end{oldproof}%

  \immediate\write\extractedfile{%
    \unexpanded\expandafter{\@percentchar}
    ============ PROOF
     ============^^J
    \unexpanded\expandafter\relax{\begin{proof}} ^^J
    \unexpanded\expandafter{\BODY}%
    ^^J
    \unexpanded\expandafter\relax{\end{proof}}
    ^^J
  }
}

