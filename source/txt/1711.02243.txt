NEARBY CYCLES OF PARAHORIC SHTUKAS,
AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

arXiv:1711.02243v2 [math.NT] 21 Feb 2018

TONY FENG
Abstract. Following the paradigm initiated by Kottwitz, we compute the trace of Frobenius composed
with Hecke operators on the cohomology of nearby cycles, at places of parahoric reduction, of perverse
sheaves on certain moduli stacks of shtukas. Inspired by an argument of NgÃ´, we then use this to give
a geometric proof of a base change fundamental lemma for parahoric Hecke algebras for GLn over local
function ï¬elds. This generalizes a theorem of NgÃ´, who proved the base change fundamental lemma for
spherical Hecke algebras for GLn over local function ï¬elds, and extends to positive characteristic (for GLn )
a fundamental lemma originally introduced and proved by Haines for p-adic local ï¬elds.

Contents
1. Introduction
2. Statement of results and overview of the paper
3. Notation
4. Moduli of shtukas
5. The Kottwitz Conjecture for shtukas
6. Counting parahoric shtukas
7. Geometrization of base change for Hecke algebras
8. Comparison of two moduli problems
9. Calculation of traces on the cohomology of nearby cycles
References

1
4
8
9
16
20
25
32
34
39

1. Introduction
There are two main goals of this paper:
(1) To compute the trace of Frobenius composed with Hecke operators on the cohomology of nearby
cycles at places of parahoric reduction for certain moduli stacks of shtukas, and
(2) To parlay the resulting formulas into a geometric proof of a fundamental lemma for base change for
central elements in parahoric Hecke algebras over local function fields.
The first goal is accomplished by using the Grothendieck-Lefschetz trace formula to break up the computation
of the trace into two pieces: (1) counting points on certain moduli spaces, and (2) understanding the stalks
of the nearby cycles sheaves. These pieces are then each resolved by a sequence of technical steps whose
overall strategy is rather well-known, and which would require a considerable amount of notation to describe.
Therefore, in this introduction we will focus on informally explaining the idea of the second goal.
The fundamental lemma of interest was proposed and proved by Haines [Hai09] for p-adic (i.e. mixed
characteristic) local fields, and generalizes the fundamental lemma for base change for spherical Hecke algebras proved (independently) in the p-adic case by Clozel [Clo90] and Labesse [Lab90], building on work of
Kottwitz [Kot86a], and in the function field case (for GLn ) by NgÃ´ [Ngo06].
The original motivation for this fundamental lemma was to study the cohomology of a Shimura variety with
parahoric level structure, and in particular to determine the semisimple zeta factor at a place of parahoric
reduction. The fundamental lemma enters in comparing the trace of Frobenius and Hecke operators on this
cohomology with the geometric side of the Arthur-Selberg trace formula. We refer the interested reader to
[Hai09], especially p. 573, for more details.
1

2

TONY FENG

The same applications are available in the function field setting, with Shimura varieties replaced by the
moduli stacks of shtukas, which have been utilized by Drinfeld ([Dri87], for GL2 ), L. Lafforgue ([Laf02], for
GLn ), and V. Lafforgue ([Laf12], for general reductive groups) to spectacular success towards the global
Langlands correspondence over function fields.
However, in this paper we have chosen to emphasize the geometric aspect of the fundamental lemma,
rather than its applications to the Langlands program. In contrast to the proof of [Hai09] for p-adic case,
which following in the tradition of [Clo90] and [Lab90] is via p-adic harmonic analysis, our proof works by
exploiting additional geometry and structure which is available in the function field setting. Our strategy is
very much based on that of [Ngo06], and indeed specializes to it in the case of spherical Hecke algebras. We
think it would be useful to give an impressionistic preview of the strategy now. A more detailed overview
will be given in Â§2.1 and Â§2.2.
Broadly speaking, the base change fundamental lemma compares an orbital integral with a twisted orbital
integral. To elaborate, let F be a local field, G a reductive group over F , Î³ âˆˆ G(F ), and f a function on
G(F ). The orbital integral corresponding to this data is
Z
f (g âˆ’1 Î³g) dg
(1.1)
OÎ³ (f ) :=
G(F )/GÎ³ (F )

where GÎ³ (F ) is the centralizer of Î³ in G(F ). We will take f to be in an appropriate Hecke algebra HG (F ).
(Of course we also need to discuss the normalization of Haar measures, but let us leave that for Â§2.1.)
Let E/F be an unramified extension of degree r, Î´ âˆˆ G(E), and fE a function on G(E). The twisted
orbital integral corresponding to this data is
Z
fE (g âˆ’1 Î´Ïƒ(g)) dg
(1.2)
TOÎ´Ïƒ (fE ) :=
G(E)/GÎ´Ïƒ (F )

where Ïƒ âˆˆ Gal(E/F ) is the lift of (arithmetic) Frobenius, and
GÎ´Ïƒ (F ) := {g âˆˆ G(E) : g âˆ’1 Î´Ïƒ(g) = Î´}
is the twisted centralizer of Î³ in GÎ´Ïƒ (E). Again, we will take fE to be in an appropriate Hecke algebra
HG (E).
If HG(E),J and HG(F ),J are corresponding parahoric Hecke algebras, then there is a base change homomorphism for their centers
b : Z(HG(E),J ) â†’ Z(HG(F ),J ).
There is also a norm map N from stable twisted conjugacy classes in G(E) to stable conjugacy classes in
G(F ).
In the special case G = GLn , the base change fundamental lemma for the center of parahoric Hecke
algebras predicts that for Ïƒ-regular, Ïƒ-semisimple Î´ âˆˆ G(E) and fE âˆˆ Z(HG(E),J ), we have
TOÎ´Ïƒ (fE ) = ON (Î´) (b(fE )).

(1.3)

This is almost what we will prove. (For more general G, the formulation is more complicated; see [Hai09],
Theorem 1.0.3 and Â§5.)
Now we can describe our strategy of proof of (1.3). The starting point is the seminal work of Kottwitz on
counting points of Shimura varieties over finite fields. In [Kot92] Kottwitz proves a formula expressing the
trace of Frobenius composed with a Hecke operator on the cohomology of certain PEL Shimura varieties as
a sum of a product of (twisted) orbital integrals:
X
(. . .)OÎ³ (hp )TOÎ´Ïƒ (hp )
(1.4)
Tr(h â—¦ Frobp , H âˆ— (ShK , Qâ„“ )) =

where ShK is an appropriate Shimura variety and h is a Hecke operator. In fact the purpose of the fundamental lemma is to re-express the twisted orbital integrals in (1.4), so as to be able to compare the expression
with the geometric side of the Arthur-Selberg trace formula. But in this paper we adopt an opposite perspective, instead viewing (1.4) as giving a geometric interpretation of (twisted) orbital integrals (in the p-adic
case) in terms of the cohomology of Shimura varieties.
In the function field setting, which is the one of interest to this paper, one can prove an analogous formula
of the form
X
(. . .)OÎ³ (hxA0 )TOÎ´Ïƒ (hA,x0 )
(1.5)
Tr(hA â—¦ Frobx0 â—¦Ï„, H âˆ— (ShtA , A)) =

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

3

for an appropriate moduli stack ShtA , an appropriate sheaf A, an appropriate Hecke operator hA , and an
additional symmetry Ï„ . (Roughly, Ï„ is a â€œrotationâ€ symmetry that arises from the moduli problem.)
However, it turns out that we can also construct a moduli stack ShtB such that
Tr(hB â—¦ Frobx0 â—¦Ï„, H âˆ— (ShtB , B)) =

X

(. . .)OÎ³ (hxB0 )OÎ´Ïƒ (b(hB,x0 ))

(1.6)

for an appropriate sheaf B, an appropriate Hecke operator hB , and an additional symmetry Ï„ similar to that
from (1.5). The crucial point is that in (1.6) the twisted orbital integral is replaced with the orbital integral
of a base changed function.
We remark that the computations (1.5) and (1.6) were obtained in [Ngo06] for places of good (hyperspecial)
reduction, in which case one finds a spherical Hecke operator. In the present work, which concerns places
of parahoric bad reduction, the analogous computations (1.5) and (1.6) are of independent interest, and
actually form the main content of this paper. They require several nontrivial inputs, including, for the
parahoric setting that we study here, a version of the Kottwitz Conjecture for shtukas, as well as a geometric
interpretation of the base change homomorphism for Hecke algebras. Nevertheless, let us elide these points
for now.
The upshot is that (1.5) and (1.6) translate the problem of comparing orbital integrals and twisted orbital
integrals into comparing (the cohomology of) two different moduli problems ShtA and ShtB . (We remark
that the relationship we seek turns out to be subtler than equality, but again we elide this issue for now.)
At this point the particular the choice of ShtA and ShtB becomes crucial. Therefore, to proceed with the
discussion we will need to give some idea of what these moduli problems look like. In (1.4) the Shimura
variety ShK is defined over an open subset of the ring of integers of a number field, whereas in (1.5) and
(1.6) the moduli stacks ShtA and ShtB are defined over an open subset X â—¦ of a curve over a finite field Fq .
The moduli stack ShtA parametrizes â€œindependentâ€ modifications of vector bundles Ei over X â—¦ , with the
modifications occuring over the point x:
ï£±
ï£¼
x âˆˆ Xâ—¦ ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
x
ï£´
Ïƒ
ï£´
ï£´
E1 99K E1 ï£´
ï£´
ï£´
ï£²
ï£½
x
Ïƒ
E
99K
E
2
2
ShtA â€œ = â€
.
ï£´
ï£´
..
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
.
ï£´
ï£´
ï£´
ï£´
x
ï£³Ïƒ
ï£¾
Er 99K Er

(Here the superscript Ïƒ refers to a Frobenius twist, which has not been explained but is a standard part of
the definition of shtukas.) On the other hand, the moduli stack ShtB parametrizes â€œiteratedâ€ modifications
of G-bundles Ei over X â—¦ :


x âˆˆ Xâ—¦
ShtB â€œ = â€ Ïƒ
.
x
x
x
Er 99K E1 99K . . . 99K Er
Forgetting everything except x defines maps
ShtA

ShtB

Xâ—¦

Xâ—¦

Now the key point is that we can deform these moduli problems by allowing the points of modification to
vary over X â—¦ (which of course is a trick only available in the function field setting). More precisely, we can
construct extended moduli stacks
gA
Sht

Ï€A

(X â—¦ )r

gB
Sht

Ï€B

(X â—¦ )r

4

TONY FENG

gA |âˆ†(X â—¦ ) and ShtB = Sht
gB |âˆ†(X â—¦ ) , by setting
such that ShtA = Sht
ï£±
ï£¼
x1 , . . . , xr âˆˆ X â—¦ ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
x
1
ï£´
Ïƒ
ï£´
ï£´
E1 99K E1 ï£´
ï£´
ï£´
ï£²
ï£½
x2
Ïƒ
g
E2 99K E2
ShtA â€œ = â€
ï£´
ï£´
..
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
.
ï£´
ï£´
ï£´
ï£´
xr
ï£³ Ïƒ
ï£¾
Er 99K Er

and

gB â€œ = â€
Sht


x1 , . . . , xr âˆˆ X â—¦
.
x
x
x
2
1
r
Ïƒ
Er 99K E1 99K . . . 99K Er



If the sheaves RÏ€A! A and RÏ€B! B are sufficiently well-behaved, then we may hope that by a â€œcontinuation
principleâ€ we can deduce a comparison theorem for the cohomology of these two moduli problems over a
diagonal point xr0 âˆˆ âˆ†(X â—¦ ) âŠ‚ (X â—¦ )r by proving such a comparison on a dense open subset of (X â—¦ )r where
the points x1 , . . . , xr are distinct. This latter comparison works by computing analogues of (1.5) and (1.6)
gA and Sht
gB over such points, away from âˆ†(X â—¦ ), which turn out to both involve only orbital integrals
for Sht
and can therefore be matched directly.
2. Statement of results and overview of the paper
2.1. Statement of the fundamental lemma. We now give a precise formulation of the fundamental
lemma of interest. It is an exact analogue for local function fields of the fundamental lemma studied in
[Hai09]. We will impose several assumptions that simplify the formulation, referring the general case to
[Hai09]. In particular we assume that Gder is simply connected.
2.1.1. Normalization of Haar measures. Recall the notation of Â§1. To give a well-defined meaning to the
orbital integral (1.1) and twisted orbital integral (1.2), we need to specify Haar measures on G, GÎ³ and GÎ´Ïƒ .
We assume that Î³ is regular semisimple.
We fix a hyperspecial vertex and an alcove containing it in the Bruhat-Tits building for G over Ft . By
Bruhat-Tits theory this induces maximal compact subgroups KF âŠ‚ G(F ) and KE âŠ‚ G(E).
â€¢ We pick the left-invariant Haar measures dg on G(F ) and G(E) such that dg(KF ) = 1 and dg(KE ) =
1.
â€¢ We pick the left-invariant Haar measures dh on GÎ³ (F ) and GÎ´Ïƒ (F ) such that dg(KF âˆ© GÎ³ (F )) = 1
and dh on GÎ´Ïƒ (E) is the canonical transfer of Haar measure from GÎ³ to its inner form GÎ´Ïƒ .
Taking the quotient measure
defined.

dg
dh

on G(F )/GÎ³ (F ) and G(E)/GÎ´Ïƒ (E), now (1.1) and (1.2) have been fully

2.1.2. Parahoric Hecke algebras. We fix a facet in the given alcove, which induces corresponding (compact open) parahoric groups JF âŠ‚ G(F ) and JE âŠ‚ G(E). Let HG(F ),J = Func (JF \G(F )/JF , Qâ„“ ) and
HG(E),J = Func (JE \G(E)/JE , Qâ„“ ) be the corresponding parahoric Hecke algebras. (Parahoric Hecke algebras are discussed in more detail in Â§5.1.)
2.1.3. The base change homomorphism. Let Z(HG(F ),J ) be the center of HG(F ),J , and define Z(HG(E),J )
similarly. There is a base change homomorphism
b : Z(HG(E),J ) â†’ Z(HG(F ),J )
which is defined in Â§7.1. To give a brief characterization of the base change homomorphism: under the
Bernstein isomorphism
âˆ¼

âˆ’ âˆ—J IK : Z(HG(F ),J ) âˆ’
â†’ HG(F ),K

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

5

obtained by convolving with the indicator function IK , it corresponds to the usual base change homomorphism for spherical Hecke algebras.
Z(HG(E),J )

b

âˆ¼ âˆ’âˆ—J IK

HG(E),K

Z(HG(F ),J )
âˆ¼ âˆ’âˆ—J IK

b

HG(F ),K

2.1.4. The norm map. Let Ïƒ âˆˆ Gal(E/F ) be a lift of (arithmetic) Frobenius. The â€œconcrete normâ€
NmE/F : G(E) â†’ G(F )
defined by
NmE/F (Î´) := Î´ Â· Ïƒ(Î´) Â· . . . Ïƒ râˆ’1 (Î´)
descends to a norm map
N : G(E)/stable Ïƒ-conjugacy â†’ G(F )/stable conjugacy.
2.1.5. Formulation of the fundamental lemma. The following fundamental lemma was proved by Haines in
the p-adic setting ([Hai09], Theorem 1.0.3.)
Theorem 2.1 (Haines). Let E/F be an unramified extension of p-adic local fields of degree r and residue
characteristic p. Let Ïˆ âˆˆ Z(HG(E),J ) and Î´ âˆˆ G(E) such that N (Î´) is semisimple. Then we have
G(E)

SOÎ´Ïƒ

(Ïˆ) = SOG
N (Î´) (b(Ïˆ)).

Here SO are stable (twisted) orbital integrals, for whose definition we refer to [Hai09] Â§5.1. Since our
eventual result will be for G = GLn , where stable conjugacy coincides with conjugacy, we can ignore the
issue of stabilization.
Remark 2.2. Haines has informed us that his proof, which is based on the global simple trace formula and
Kottwitzâ€™s stabilization of the twisted trace formula, does not carry over (at least, not without nontrivial
additional work) to the positive characteristic setting. 1
We now formulate our main result, which is an extension (in a special case) of Theorem 2.1 to positive
characteristic.
By the Bernstein isomorphism, a basis for Z(HG(E),J ) is given by the functions ÏˆÂµ for Âµ a dominant
coweight of G, which correspond under âˆ’âˆ—J IK to the indicator functions of the double coset in KE \G(E)/KE
indexed by Âµ.
Example/Definition 2.3. If G = GLn , and T âŠ‚ GLn is the usual (diagonal) maximal torus, then we
may identify Xâˆ— (T ) âˆ¼
= Zn in the standard way. The dominant weights coweights Xâˆ— (T )+ are those Âµ =
(Âµ1 , . . . , Âµn ) with Âµ1 â‰¥ Âµ2 â‰¥ . . . â‰¥ Âµn . We define
|Âµ| := Âµ1 + . . . + Âµn .
In this paper we prove:
Theorem 2.4. Let E/F be an unramified degree r extension of characteristic p local fields. If Î´ âˆˆ GLn (E)
is such that N (Î´) is regular semisimple and separable, and Ïˆ âˆˆ Z(HGLn (E),J ) is a linear combination of ÏˆÂµ
with |Âµ| = 0, then we have
TOÎ´Ïƒ (Ïˆ) = ON (Î´) (b(Ïˆ)).
Remark 2.5. Let us make some remarks on the hypotheses. The hypothesis |Âµ| = 0 arises geometrically as
a condition for the non-emptiness of moduli stacks of shtukas.
The restriction to GLn comes from a need to obtain a proper moduli stack, in order to have enough control
over the cohomology of the relevant moduli stacks of shtukas. In general the moduli stacks of shtukas are of
infinite type, and their cohomology not constructible. However, for GLn we can use the trick of globalizing
to a division algebra in order to create a proper global space with the right local behavior.
1However, we note that W. Ray Dulany proved the base change fundamental lemma for GL by hand in the function ï¬eld
2
case [RD]. We thank Tom Haines for informing us about Ray Dulanyâ€™s work.

6

TONY FENG

Remark 2.6. It seems likely that the theorem can be extended to prove Conjecture 2.1 in full for G = GLn
using methods that are by now considered â€œstandardâ€, as in [Clo90]. One reason we have not bothered to
do this is that the constraint |Âµ| = 0 is necessary in order to make the geometric objects non-trivial, and so
is satisfied in applications of the fundamental lemma to study the cohomology of moduli stacks of shtukas
via the Arthur-Selberg trace formula. Therefore, Theorem 2.4 should be adequate for applications to the
Langlands program.
Remark 2.7. As T. Haines pointed out to us, another key aspect of the fundamental lemma is the assertion
that OÎ³ (b(Ïˆ)) = 0 if Î³ is not a norm. Our strategy does not seem to naturally give access to this statement.
On the other hand, since Labesse gave a purely local proof of this statement for the spherical case in mixed
characteristic, which was extended to the center of parahoric Hecke algebras in [Hai09] Â§5.2, it should
generalize to positive characteristic. We intend to include this in a future work, when it becomes necessary.
2.1.6. Related work. The fundamental lemma for base change for spherical Hecke algebras, which arises from
Theorem 2.1 in the special case where J = K is a hyperspecial maximal compact subgroup, was proved in
the p-adic case by Clozel [Clo90] and Labesse [Lab90], using key input from Kottwitz [Kot86a] who checked
it for the unit element. These arguments were generalized by Haines to proved the base change fundamental
lemma for centers of parahoric Hecke algebras, as has been discussed.2
For local function fields (i.e. positive characteristic), the spherical case J = K of Theorem 2.4 was
established by NgÃ´ [Ngo06], also for GLn and also for |Âµ| = 0 (with the same reasons for the restrictions).
Indeed, our strategy as described in Â§1 is the one pioneered by [Ngo06]. Similar results were obtained
independently and simultaneously by Lau [Lau04]. The key to our generalization is that in the parahoric
case, we know enough about the nearby cycles sheaf at a place of bad reduction, thanks to the proof of a
â€œKottwitz Conjecture for shtukasâ€ due to Gaitsgory [Gai01], to carry out the geometric argument.
2.2. Overview of the proof. Let us now give a more detailed overview of the proof of Theorem 2.4. We
are trying to prove a local result, but we will immediately shift to a global setting. Therefore, we change
notation from before. Let Fx0 be a local function field of characteristic p, so we have non-canonically
Fx âˆ¼
= Fq ((t)).
0

As the notation suggests, we view Fx0 as the completion of a global function field F at a place x0 , and we
view F as the global function field of a smooth projective curve X/Fq . (Note that we have implicitly taken
x0 to be a point of degree one on X, which is actually important.)
Let G be a reductive group over F and J âŠ‚ G(Fx0 ) a parahoric subgroup. We choose any extension of
bX,x0 ), we have
G to parahoric group scheme G â†’ X such that over the completed local ring Spec (Ox0 := O
G(Ox0 ) = J. We assume that G âŠ—F Fx is split at all x where G(Ox ) is not hyperspecial.
Following [Ngo06], in Â§8 we define two moduli stacks of G-shtukas which we call ShtA and ShtB . (We have
included a background section summarizing the essential constructions and facts about shtukas in Â§4.) Let
E/F be the unramified extension of degree r. As outlined in Â§1, the goal is threefold:
(1) Obtain an expression relating the trace of Frobenius composed with Hecke operators on the cohomology of ShtA to the twisted orbital integral of Ïˆ âˆˆ Z(HG(Ex0 ),J ).
(2) Obtain an expression relating trace of Frobenius composed with Hecke operators on the cohomology
of ShtB to the orbital integral of the base changed function b(Ïˆ).
(3) Relate the two cohomology groups in question in some other way.
Let us discuss each of these tasks in turn. For (1), we need a geometric interpretation of the center of the
parahoric Hecke algebra HG(Fx0 ),J . It is well-known that the spherical Hecke algebra is geometrized, under
the function-sheaf dictionary, by perverse sheaves on the affine Grassmannian. Similarly, the parahoric Hecke
algebra is geometrized by a partial affine flag variety.
This story is globalized by the Beilinson-Drinfeld Grassmanian GrG â†’ X. Over a general point of X
the fiber of GrG is an affine Grassmannian, but because G is a parahoric group at x0 , the fiber over x0 is
actually a partial affine flag variety. It is essentially a result of Gaitsgory, although the formulation in [Gai01]
2See the last paragraph of the introduction to [Hai09] for a discussion of to what extent Conjecture 2.1 follows from the

fundamental lemma for twisted endoscopy. Although base change is a special case of twisted endoscopy, the fundamental lemma
for twisted endoscopy should imply that there is a matching function for Ïˆ, but does not identify it in terms of the base change
homomorphism.

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

7

is slightly different, that the nearby cycles functor takes perverse sheaves on GrG |Xâˆ’x0 to central perverse
sheaves on GrG |x0 âˆ¼
= FlG,J .
Using this, in Â§5 we relate the trace function associated to the nearby cycles sheaf at x0 of perverse sheaves
on ShtG to central elements of HG,J . This is the desired geometrization of Z(HG(Ex0 ),J ). The key point is
that the Beilinson-Drinfeld Grassmannian is a smooth (even Ã©tale) local model for ShtG .
In Â§6 we give a counting formula for points of ShtA , in the style of Kottwitz [Kot92]. This formula is based
on [Ngo06] and [NND08]; however we must note that it only gives a â€œpartial formulaâ€, counting only those
points indexed by an elliptic Kottwitz triple. Indeed, since the moduli stacks of shtukas are of infinite type
in general (even with full level structure and bounded modifications), they can have infinitely many points
over finite fields in general, which makes it somewhat subtle to give a meaningful formula. This issue can
be bypassed altogether for GLn by taking G to be the group associated to a sufficiently ramified division
algebra over X, with G(Fx0 ) âˆ¼
= GLn (Fx0 ). This trick is one major reason for the restriction to GLn ; another
(which is morally of the same nature) will arise in the discussion of (3).
These ingredients are put together in Â§9.1, obtaining a formula
ï£«
ï£¶
X
Y
â€²
(. . .) ï£­
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (AÂµr )) =
OÎ³v (fÎ²v )ï£¸ Â· TOÎ´x0 Ïƒ (Ïˆr,Âµ
).
(2.1)
v6=x0

See Theorem 9.2 for the precise statement.

Now we turn our attention to (2). All the same ingredients and steps are required as in (1), but now we
additionally need a geometric interpretation of the base change homomorphism
b : Z(HG(Ex0 ),J ) â†’ Z(HG(Fx0 ),J ).
This problem is studied in Â§7 for split reductive G, generalizing results of NgÃ´ for GLn [Ngo99]. First,
by a local study of the affine Grassmannian we prove the following fact. Let SatGrG (Âµ) be the perverse
sheaf on GrG corresponding, under Geometric Satake, to the dominant coweight Âµ âˆˆ Xâˆ— (T )+ , and let Ïˆr,Âµ
be the trace function of Frobr on SatGrG (Âµ); thus Ïˆr,Âµ âˆˆ HG,K (Ex0 ). Then b(Ïˆr,Âµ ) is the trace function
associated to Frob â—¦Îºâ€² on SatGrG (Âµ)âˆ—r , where SatGrG (Âµ)âˆ—r is the r-fold convolution of SatGrG (Âµ) and Îºâ€² is
a cyclic permutation of order r using from the commutativity constraint on perverse sheaves on the affine
Grassmannian [MV07]. See Theorem 7.15 for the precise statement. We emphasize again that this was
obtained already by NgÃ´ for GLn , which is really the only situation where we can currently prove Conjecture
2.1; we prove the more general statement here in anticipation of future generalizations.
Using the global degeneration from a Beilinson-Drinfeld Grassmanian, we prove an analogous generalization to the center of parahoric Hecke algebras in terms of nearby cycles sheaves; see Theorem 7.17 for the
precise statement. This result is used as a local model to understand sheaves on ShtB , and is assembled in
Â§9.2 in conjunction with the ingredients mentioned in the discussion of (1) to obtain a formula
ï£«
ï£¶
X
Y
â€²
(. . .) ï£­
Tr(hÎ² â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (BrÂµ )) =
OÎ³v (fÎ²v )ï£¸ Â· OÎ³x0 (b(Ïˆr,Âµ
)).
(2.2)
v6=x0

See Theorem 9.3 for the precise statement.

Finally, we address (3). As discussed in Â§1 the moduli problems ShtA and ShtB are actually defined over
(X â—¦ )r . By analogous but easier arguments we can prove that
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx â—¦Ï„, AÂµr ) = Tr(hÎ² â—¦ Frobx â—¦Ï„, BrÂµ )
for x âˆˆ (X â—¦ )r consisting of r pairwise-distinct points. (We caution that the relationship between AÂµr and BrÂµ
is not one of equality. Rather, the former is more like the rth tensor power of the latter, and the equality of
traces is the nonobvious linear algebraic identity in Lemma 7.13.) In other words, we can obtain analogues
of (2.1) and (2.2) which are manifestly equal at sufficiently many (by Chebotarev density) x. In fact since
ShtA and ShtB have good (hyperspecial) reduction at almost all such x this already follows from [Ngo06] Â§5,
where the proof is exactly as was just indicated; we give a more detailed sketch of NgÃ´â€™s proof in Â§8.4.
However, knowing the equality for x âˆˆ U := (X â—¦ )r âˆ’ âˆ†(X â—¦ ) is not itself sufficient for deducing an
equality at a point of âˆ†(X â—¦ ). It would be sufficient if the sheaves AÂµr and BrÂµ were local systems in a

8

TONY FENG

neighborhood of a point of âˆ†(X â—¦ ) âŠ‚ (X â—¦ )r . In fact, since they are equipped with a partial Frobenius
structure, by â€œDrinfeldâ€™s Lemmaâ€ ([Dri87] Proposition 6.1, [Lau04] Lemma 9.2.1) if they were even merely
constructible then they would automatically be local systems in a neighborhood of the generic point of
âˆ†(X â—¦ ) âŠ‚ (X â—¦ )r . Unfortunately, as has already been discussed, the moduli stacks of shtukas are of infinite
type in general, and their cohomology is not even constructible on (X â—¦ )r . Here again we invoke the trick of
using a sufficiently ramified division algebra in order to enforce the properness of the global moduli stack,
and thus the constructibility; of course the cost is that this only gives results for GLn .
2.3. Summary of the paper. Although we discussed in Â§2.2 why our current argument does not work
beyond GLn , we hope that after future technical improvements in the theory of shtukas it can be generalized
to a much wider class of reductive groups. For this reason, for the individual steps we have tried to work
with more general groups when possible. It seems worthwhile to give a brief outline of the organization of
the paper, pointing out exactly where we can be more general.
In Â§4 we review the theory of shtukas for nonconstant reductive group schemes, summarizing the essential
background facts. Also, a key point is to define an â€œintegral modelâ€ for the moduli stack of shtukas, extending
over points of parahoric bad reduction.
In Â§5 we establish an analogue of the Kottwitz Conjecture for moduli of shtukas. This works even for
fairly general (not necessarily constant) reductive groups G â†’ X: Gaitsgory originally proved it for constant
groups, and his argument was generalized by Zhu in [Zhu14] Theorem 7.3 and Pappas-Zhu in [PZ13].
In Â§6 we establish some counting formulas for points of shtukas over finite fields. This is a minor variant
of the work of NgÃ´ B.C. and NgÃ´ Dac T., which was previously only formulated at places hyperspecial level
structure. Our contribution is to write it out for the case of parahoric bad reduction that we require.
In Â§7 we provide a geometric interpretation of the base change homomorphism for spherical Hecke algebras
and the center of parahoric Hecke algebras for general split reductive groups G over a local field. For GLn
this was proved by NgÃ´, in a formulation that was rather specific to GLn . We generalize the argument to
spherical Hecke algebras for arbitrary split reductive groups, and then use that to deduce a result for (central
elements in) parahoric Hecke algebras.
In Â§8 we introduce the two moduli problems ShtA and ShtB which are to be compared, and recall NgÃ´â€™s
theorem stating the precise comparison. Using this we deduce an equality of traces on the nearby cycles
sheaves at the point of parahoric reduction. Here we also crucially use that the moduli of shtukas associated
to a sufficiently ramified division algebra is proper, which implies that the cohomology is a local system.
In Â§9 we compute these traces in terms of (twisted) orbital integrals, giving formulas in the paradigm of
Kottwitz, and then use them in Â§9.3 to deduce the cases of the base change fundamental lemma claimed in
Theorem 2.4.
2.4. Acknowledgments. I am indebted to Zhiwei Yun for teaching me basically everything that I know
about shtukas, and in particular for directing me to [Ngo06]. I would also like to thank Zhiwei, Laurent
Clozel, Gurbir Dhillon, Tom Haines, Jochen Heinloth, Urs Hartl, Bao Le Hung, and Rong Zhou for helpful
conversations related to this work. This document benefited enormously from comments, corrections, and
suggestions by Brian Conrad, Tom Haines, and Timo Richarz.
This project was conceived at the 2017 Arbeitsgemeinschaft in Oberwolfach, and completed while I was
a guest at the Institute for Advanced Study, and under the support of an NSF Graduate Fellowship. I am
grateful to these institutions for their support.
3. Notation
We collect some notation that will be used frequently throughout the paper.
â€¢ Let X be a smooth projective curve over a finite field k = Fq , and let F = k(X) be its global function
field. We fix a point x0 âˆˆ X(Fq ).
â€¢ We will let X â—¦ be an open subset of X, usually the complement of some points for ramification and
possibly also x0 .
â€¢ We denote by |X| the set of closed points of X, and for x âˆˆ X we write k(x) for the residue field of
x.
â€¢ For x âˆˆ X, we let Ox be the completion of OX,x at its maximal, and Fx be the fraction field of Ox .
We set Dx := Spec Ox .

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

9

â€¢ We let G be a connected reductive group over F , whose derived group is simply connected. We
assume that G extends to a parahoric group scheme G â†’ X, and that G âŠ— Fx is split at all points
x âˆˆ X where G(Ox ) is not hyperspecial.
â€¢ We denote by E 0 the trivial (fppf) G-torsor over X.
4. Moduli of shtukas
In this section we recall material concerning shtukas and their perverse sheaves. This is mostly background,
but we emphasize that it is important for us to work at the generality of nonconstant groups. This allows
us to define an â€œintegral modelâ€ for parahoric shtukas, which is much easier than the corresponding problem
for Shimura varieties. References for this section are [Zhu14] Â§3 and [Laf12] Â§12.
4.1. G-bundles. Let G â†’ X be a smooth affine group scheme with (connected) reductive generic fiber G,
such that G|Ox is a parahoric group scheme for each x âˆˆ X. We assume that G|Fx is split at all points x âˆˆ X
where G(Ox ) is not hyperspecial.
4.1.1. We recall the notion of G-bundles and affine Grassmannians, the study of which seems to have been
initiated by [PR10].
Definition 4.1. A G-bundle E is a G-torsor for the fppf topology. We define BunG to be the (Artin) stack3
representing the functor
BunG : S 7â†’ {G-bundles on X Ã— S} .
Definition 4.2. We define the global affine Grassmannian GrG to be the (Artin) stack representing the
functor
ï£±
ï£¼
x âˆˆ X(S)
ï£²
ï£½
GrG : S 7â†’ (x, E, Î²) :
E âˆˆ BunG (S)
ï£³
ï£¾
Î² : E|XS âˆ’Î“x âˆ¼
= E 0 |XS âˆ’Î“x
where here and throughout E 0 denotes the trivial G-torsor.
We have a map

Ï€ : GrG â†’ X
sending (x, E, Î²) 7â†’ x.
Example 4.3. Let Gx = G|Dx . Then
GrG |x := Ï€ âˆ’1 (x) âˆ¼
= GrGx
is the usual affine Grassmannian for Gx . On the other hand if G|Dx is an Iwahori group scheme, then
GrG,x âˆ¼
= FlGx is the usual affine flag variety.
4.1.2. Arc and loop groups. We now give a different perspective on BunG in terms of â€œloop groupsâ€. (The
objects introduced here will also be important later.)
Let BunG,âˆÎ“ be the moduli stack of G-bundles with â€œinfinite level structureâ€, i.e.
ï£±
ï£¼
x âˆˆ X(S)
ï£²
ï£½
BunG,âˆÎ“ : S 7â†’ (x, E, Ïˆ) : E âˆˆ BunG (S)
âˆ¼
ï£³
ï£¾
â†’ E 0 |Î“bx
Ïˆ : E|Î“bx âˆ’

b x is the completion of X Ã— S along Î“x . One can also think of Ïˆ as a compatible family of level
where Î“
b â—¦x := Î“
b x âˆ’ Î“x (the meaning is as in [Laf12] Notation 1.7).
structures over nÎ“x as n â†’ âˆ. We set Î“
+
Let L G be the global â€œarc groupâ€, defined by


x âˆˆ X(S)
+
L G : S 7â†’ (x, Î²) :
bx ) .
Î² âˆˆ G(Î“

Let LG be the â€œloop groupâ€



x âˆˆ X(S)
LG : S 7â†’ (x, Î²) :
b â—¦x ) .
Î² âˆˆ G(Î“

Remark 4.4. There is an action of L+ G on GrG by changing the level structure Ïˆ.
3For the fact that this is really an Artin stack in the generality required here, see [Bro13]. We thank Brian Conrad for
bringing this reference to our attention.

10

TONY FENG

4.1.3. Global Schubert varieties. Let T âŠ‚ G be a maximal torus. In [Ric16] Â§2 (generalizing work in the
tamely ramified case of [Zhu14] Â§3.3) it is shown how to associate to Âµ âˆˆ Xâˆ— (TF ) a global Schubert variety
Grâ‰¤Âµ
G . Of course, this is well-known in the split case.
4.1.4. Geometric Satake. We fix some notation pertaining to the Geometric Satake correspondence ([MV07]).
Definition 4.5. Given a finite-dimensional representation W of L G, we let SatGrG (W ) be the associated perverse sheaf on GrG furnished by Geometric Satake. Note that SatGrG (W ) is automatically L+ G-equivariant.
(For a statement of Geometric Satake for non-constant groups, see [Laf12] Theorem 12.16.)
b are indexed by dominant
If G is split then irreducible finite-dimensional representations W of L G = G
coweights Âµ âˆˆ Xâˆ— (T )+ for a maximal split torus T âŠ‚ G, and we denote by SatGrG (Âµ) := SatGrG (WÂµ ) the
corresponding perverse sheaf.
This is the primal source for constructing perverse sheaves on a plethora of objects, which will all be
denoted Sat... (W ) or Sat... (Âµ).
Remark 4.6. The sheaves SatGrG (W ) are L+ G-equivariant for the action of Remark 4.4.
4.2. Hecke stacks.
4.2.1. We now define objects that geometrize the Hecke operators.
Definition 4.7. We define the Hecke stack HeckeG by the functor of points
ï£¼
ï£±
x âˆˆ X(S)
ï£½
ï£²
E, E â€² âˆˆ BunG (S)
.
HeckeG : S 7â†’ (x, E, E â€² , , Ï•) :
ï£¾
ï£³
âˆ¼
â†’ E|XÃ—Sâˆ’Î“x
Ï• : E â€² |XÃ—Sâˆ’Î“x âˆ’
We have structure maps

HeckeG
â– â– 
âœ‰
â– â–  hâ†’
âœ‰
h âœ‰âœ‰
â– â– 
Ï€
âœ‰
â– â– 
âœ‰
âœ‰
â– $
âœ‰
zâœ‰

BunG
X
BunG
â†

where the map hâ† takes (E, E â€² ) 7â†’ E, and the map hâ†’ takes (E, E â€² ) 7â†’ E â€² .
One can think of the HeckeG as looking locally, in the smooth topology, like BunG Ã—X GrG . To make this
precise, recall that there is an action of L+ G on BunG,âˆÎ“ , by changing the level structure.
Proposition 4.8. There is an isomorphism
âˆ¼

â†’ (GrG Ã—X BunG,âˆÎ“ )/L+ G
Î¾ : HeckeG âˆ’
where the quotient is for the diagonal action of L+ G.
This is actually taken as the definition of the Hecke stack in [Laf12] Â§12.3.1. Although it is well-known
we have not found the statement formulated in quite this way, so we give a proof for completeness.
âˆ¼

â†’ (GrG Ã—X BunG,âˆÎ“ )/L+ G is equivalent to giving an L+ G-equivariant
Proof. Giving an isomorphism HeckeG âˆ’
+
isomorphism from an L G-torsor over HeckeG to GrG Ã—X BunG,âˆÎ“ , so we will construct the latter.
^ G â†’ HeckeG be the L+ G-torsor representing (x, Ï• : E â€² 99K E) âˆˆ HeckeG plus a choice of trivialLet Hecke
ization Ïˆ : E|Î“bx âˆ¼
= E 0 |Î“bx .
There is a map
^ G â†’ GrG Ã—X I BunG,âˆÎ“
Hecke
sending
(x, Ï• : E â€² 99K E, Ïˆ) 7â†’ (x, E â€² , Ïˆ â—¦ Ï•), (x, E, Ïˆ)
where we have implicitly used the Beauville-Laszlo theorem ([Zhu14], Lemma 3.1) to extend Ï• â—¦ Ïˆ, which
b â—¦ , to X âˆ’ Î“x . It is easily checked that this is an isomorphism, by defining an
is a priori only defined on Î“
x
inverse directly, and that is L+ G-equivariant.

Remark 4.9. In practice, we can always translate these statements into ones about finite type Artin stacks,
by bounding the type of the modification. On any finite type substack the action of L+ G factors through a
finite Ã©tale quotient.

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

11

4.2.2. Geometric Satake for Hecke.
Definition 4.10. We define a functor
SatHeckeG : RepL G â†’ Perv(HeckeG )
as follows. If W âˆˆ RepL G , then
SatGrG (W ) âŠ  Qâ„“,BunG,âˆÎ“ âˆˆ Dcb (GrG Ã—X BunG,âˆÎ“ )
descends to the quotient by L+ G by the fact that SatGrG (W ) is L+ G-equivariant. We set SatHeckeG (W ) to
be the pullback of this descent via the isomorphism Î¾ âˆ— from Proposition 4.8.
4.2.3. Hecke stacks with bounded modification. For Âµ âˆˆ Xâˆ— (TF ) we define HeckeÂµG as follows. First, we have
the Schubert variety GrGâ‰¤Âµ â†’ GrG , which has an L+ G-action. This induces a substack of (GrG Ã—X BunG,âˆÎ“ )/L+ G,
and we define HeckeÂµG to be the pullback via Î¾ âˆ— of Proposition 4.8.
If G = GÃ—X is constant and split over X, then Heckeâ‰¤Âµ
G admits a very concrete definition as â€œmodifications
of G-bundles with invariant bounded by Âµâ€. In Â§4.5 we explicate this for GLn -bundles, which may be an
enlightening example.
4.3. Shtukas.
4.3.1. We now define the moduli stack of G-shtukas. At places x âˆˆ X where G|Dx is a parahoric group
scheme, this should be thought of as an â€œintegral modelâ€ of the usual moduli stacks in which the legs are
demanded to be disjoint from the level structure.
Definition 4.11. We define the moduli stack of G-shtukas by the following cartesian diagram
ShtG

BunG
Id Ã— Frob

HeckeG

hâ† Ã—hâ†’

BunG Ã— BunG

More explicitly, ShtG represents the following moduli problem:
ï£¼
ï£±
x âˆˆ X(S)
ï£½
ï£²
E âˆˆ BunG (S)
ShtG : S 7â†’ (x, E, Ï•) :
ï£¾
ï£³
âˆ¼
â†’ E|XÃ—Sâˆ’Î“x
Ï• : Ïƒ E|XÃ—Sâˆ’Î“x âˆ’

where Ïƒ is the Frobenius on the S factor in X Ã— S, and Ïƒ E is the pullback of E under the map 1 Ã— Ïƒ : X Ã— S â†’
X Ã— S.
We have an evident map
Ï€ : ShtG â†’ X
sending (x, E, E â€² , Ï•) 7â†’ x.
4.3.2. Perverse sheaves on shtukas. From Definition 4.11 we have a tautological map
Î¹ : ShtG â†’ HeckeG .
Definition 4.12. For W âˆˆ Rep(L G), we define SatShtG (W ) to be Î¹âˆ— (SatHeckeG (W )) shifted to be perverse
along the fibers of Ï€ : ShtG â†’ X. This is a perverse sheaf up to shift on ShtG .
4.3.3. Schubert varieties of shtukas. For Âµ âˆˆ Xâˆ— (TbF ), we define Shtâ‰¤Âµ
= Î¹âˆ— Heckeâ‰¤Âµ
G
G . This is a closed
substack of ShtG which is the support of SatShtG (Âµ) We call these â€œSchubert varieties of shtukasâ€ even though
they are, of course, not varieties but (Deligne-Mumford) stacks.

12

TONY FENG

4.3.4. Hecke operators on shtukas. There are Hecke correspondences of shtukas that induce Hecke operators
on ShtG , hence on their cohomology.
Definition 4.13. We define Hecke(ShtG ) to be the moduli stack parametrizing x, y âˆˆ X(S) along with a
diagram
Ïƒ

x

E

Î² y

Ïƒ(Î²) Ïƒ(y)
x

Ïƒ â€²

E

E
Eâ€²

Here we note:
â€¢ E and E â€² are G-torsors on X Ã— S, and Ïƒ E and Ïƒ E â€² are their twists by 1 Ã— Ïƒ.
â€¢ The x above the horizontal arrows mean an isomorphism on the complement of Î“x .
â€¢ The y (resp. Ïƒ(y)) next to the vertical arrows means an isomorphism on the complement of Î“y (resp.
Î“Ïƒ(y) ).
â€¢ The map Ïƒ(Î²) is the twist of Î². We emphasize that it is determined by Î², rather than being an
additional datum.
We evidently have a diagram
Hecke(ShtG )

HeckeG
Ï€

Ï€2

X
where the horizontal arrow sends this data to (y, E, E â€² , Î²), which allows us to define Hecke(ShtG )â‰¤Âµ for
Âµ âˆˆ Xâˆ— (TF ), and SatHecke(ShtG ) (W ) for W âˆˆ Rep(L G).
We also evidently have a diagram
Hecke(ShtG )
h

â†

hâ†’

ShtG

ShtG

where the arrows hâ† and hâ†’ send this data to (x, Ïƒ E 99K E) and (x, Ïƒ E â€² 99K E â€² ) respectively. For v âˆˆ X, let
âˆ’1
Hecke(ShtG )â‰¤Âµ
v := Ï€2 (v).

A choice of v âˆˆ X and Âµ âˆˆ Xâˆ— (TF ) induces a correspondence
Hecke(ShtG )â‰¤Âµ
v
h

â†

hâ†’

ShtG

ShtG
Ï€

(4.1)

Ï€

X
which is the analogue of the classical Hecke correspondences.
Definition 4.14. Since Ï€ â—¦ hâ† = Ï€ â—¦ hâ†’ and hâ†âˆ— (SatShtG (W )) âˆ¼
= hâ†’âˆ— (SatShtG (W )), from Hecke(ShtG )vâ‰¤Âµ
b
we get a corresponding Hecke operator on RÏ€! SatShtG (W ) âˆˆ Dc (X).
4.4. Iterated shtukas and factorization. This entire discussion carries through to â€œiteratedâ€ versions of
GrG , HeckeG and ShtG . We will content ourselves with stating the essentials, leaving the reader to generalize
the preceding discussion. (A reference is [Laf12] Â§1,2.)

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

13

4.4.1. Iterated affine Grassmannian. The iterated global affine Grassmannian

is defined by the functor of points
ï£±
ï£´
ï£´
ï£²

e GrG â†’ X 2
Ï€ : GrG Ã—

ï£¼
x1 , x2 âˆˆ X(S)
ï£´
ï£´
ï£½
E1 , E2 âˆˆ BunG (S)
e GrG : S â†’
âˆ¼
(x1 , x2 , E1 , E2 , Ï•, Î²) :
GrG Ã—
7
â†’ E2 |XS âˆ’Î“x1 ï£´
Ï• : E1 |XS âˆ’Î“x1 âˆ’
ï£´
ï£´
ï£´
ï£³
ï£¾
âˆ¼
â†’ E 0 |XS âˆ’Î“x2
Î² : E2 |XS âˆ’Î“x2 âˆ’

e ...Ã—
e GrG (r times), although the reader should be warned that this
We may denote GrG,X r = GrG Ã—
notation is sometimes used elsewhere in the literature to denote a different object. We also have Schubert
â‰¤(Âµ ,...,Âµr )
in a way that is by now obvious.
cells: given Âµ1 , . . . , Âµr âˆˆ Xâˆ— (TF ), we can define GrG,X1r
4.4.2. Iterated shtukas. We now define the iterated shtukas.
Definition 4.15. We define the moduli stack ShtG,X r by the functor of points:
ï£±
ï£¼
x1 , . . . , xr âˆˆ X(S)
ï£²
ï£½
âˆ¼ Ïƒ
â†’ E0 âˆˆ BunG (S)
E0 , E1 , . . . , Er âˆ’
ShtG,X r : S 7â†’
ï£³
ï£¾
âˆ¼
â†’ Ei+1 |XÃ—Sâˆ’Î“xi+1
Ï•i : Ei |XÃ—Sâˆ’Î“xi+1 âˆ’

Remark 4.16. The stack of iterated shtukas ShtG,X r can also be defined as a repeated fibered product of
ShtG over BunG , which is more analogous to how we defined ShtG .
We have an evident map
Ï€ : ShtG,X r â†’ X r
projecting to the datum of (x1 , . . . , xr ).
We can similarly define HeckeG,X r and Hecke(ShtG,X r ). For a tuple W1 , . . . , Wr âˆˆ Rep(L G) we can define
a shifted perverse sheaf SatShtG,X r (W1 , . . . , Wr ) using Geometric Satake.
â‰¤(Âµ ,...,Âµr )
We also have Schubert cells for ShtG,X r : given Âµ1 , . . . , Âµr âˆˆ Xâˆ— (TbF ), we can define ShtG,X1r
in a way
that is by now obvious.

4.5. D-shtukas. As explained in Â§2.2, one difficulty with ShtG is that it is of infinite type in general. To
study the fundamental lemma for GLn , we can globalize to a division algebra instead of the constant group
GLn , which gives us a proper moduli problem. We now explain the salient facts about this special case.
Since the literature already contains several excellent expositions of the theory of D-shtukas, we will content
ourselves with a brief summary. A reference for everything here is [Ngo06] Â§1; see [Laf97] or [Lau04] for more
extensive treatments.
Let D be a division algebra F of dimension n2 , ramified over a (necessarily finite) set of points Z âŠ‚ X.
We assume that our fixed (rational) point x0 âˆˆ
/ Z, so Dx0 := D âŠ—F Fx0 âˆ¼
= gln (Fx0 ). Later we will need to
assume that #Z is sufficiently large.
We extend D to an OX -algebra D such that Dx is a maximal order in Dx for all x, and we let G â†’ X
be the associated group scheme of units. Let G â†’ X be a corresponding parahoric group scheme; we will be
most interested in the case where G is not hyperspecial at x0 .
4.5.1. Modification types. Let T âŠ‚ GLn be the standard maximal torus. The dominant coweights are
Xâˆ— (T )+ âˆ¼
= Zn+ := {Âµ = (Âµ1 , . . . , Âµn ) : Âµ1 â‰¥ Âµ2 â‰¥ . . . Âµn }.

The relative position of lattices in k[[t]]n is a Âµ âˆˆ Xâˆ— (T )+ determined by the Cartan decomposition
[
GLn (k[[t]])tÂµ GLn (k[[t]]).
GLn (k((t))) =
ÂµâˆˆXâˆ— (T )+

âˆ¼

â†’
Let X â—¦ := X âˆ’Z âˆ’{x0}. For x âˆˆ X â—¦ , a modification of G-bundles outside x is an isomorphism Ï• : E â€² |X â—¦ âˆ’x âˆ’
âŠ•n
E|X â—¦ âˆ’x . We can view E â€² |Spec F x and E|Spec F x as two lattices in F x by using Ï• âŠ— Fx to identify their generic
fibers. The relative position Âµ of these two lattices will be called the modification type of Ï•.

14

TONY FENG

4.5.2. The global affine Grassmannian. We can interpret Grâ‰¤Âµ
G |X â—¦ as the substack of GrG |X â—¦ parametrizing
Î² : E|XS âˆ’Î“x âˆ¼
= E 0 |XS âˆ’Î“x
such that for each geometric point of S, the modification type of Î² is â‰¤ Âµ. The sheaf SatGrG (Âµ) is the IC
sheaf of Grâ‰¤Âµ
G , i.e. the middle extension of the constant sheaf on the open cell.
Proposition 4.17. The sheaf SatGrG (Âµ) is universally locally acyclic with respect to the morphism GrG |X â—¦ â†’
X â—¦.
Proof. This is [Ngo06] Â§1.1 Corollaire 6. Note that NgÃ´â€™s formulation is slightly different, but is actually
deduced from the version that we state, which is the usual formulation in Geometric Satake.

â—¦
4.5.3. The Hecke stack. The Hecke stack Heckeâ‰¤Âµ
G |X â—¦ parametrizes modifications of G-torsors over X
âˆ¼

â†’ E|XÃ—Sâˆ’Î“x )
(x, Ï• : E â€² |XÃ—Sâˆ’Î“x âˆ’
with modification type â‰¤ Âµ at all geometric points of S.
4.5.4. Shtukas and iterated shtukas. The moduli stack ShtG,(Xâˆ’Z)r parametrizes
ï£±
ï£¼
x1 , . . . , xr âˆˆ (X âˆ’ Z)(S)
ï£²
ï£½
E0 , E1 , . . . , Er âˆ¼
= Ïƒ E0 âˆˆ BunG (S)
âˆ¼
ï£³
ï£¾
â†’ Ei+1 |XÃ—Sâˆ’Î“xi+1
Ï•i : Ei |XÃ—Sâˆ’Î“xi+1 âˆ’
â‰¤(Âµ ,...,Âµ )

1
r
The Schubert â€œvarietyâ€ ShtG,(Xâˆ’Z)
associated to (Âµ1 , . . . , Âµr ) âˆˆ (Xâˆ— (T )+ )r is the substack where the
r
modification type of Ï•i is bounded by Âµi at all geometric points of S. For such a tuple we can also form
â‰¤(Âµ1 ,...,Âµr )
SatShtG ,(Xâˆ’Z)r (Âµ1 , . . . , Âµr ) on ShtG,(Xâˆ’Z)r , which is perverse up to shift and supported on ShtG,(Xâˆ’Z)
r .

Proposition 4.18. The (shifted) perverse sheaf SatShtG ,(Xâˆ’Z)r (Âµ1 , . . . , Âµr )|(X â—¦ )r is locally acylic with respect
to the morphism Ï€ : SatShtG ,(Xâˆ’Z)r |(X â—¦ )r â†’ (X â—¦ )r .
Proof. This [Ngo06] Â§1.4 Corollaire 2, but with the same remark as in the proof of Proposition 4.17.



4.5.5. Global geometry. The stack ShtG has infinitely many connected components owing to the positivedimensional center of G. We wish to and can rectify this in the usual way: let a âˆˆ AÃ—
F be a non-trivial idele
Z
of degree 1, and let ShtG /a be the quotient obtained by formally adjoining an isomorphism E âˆ¼
= E âŠ— O(a).
Similarly define ShtG,(Xâˆ’Z)r /aZ . We still have the map
Ï€ : ShtG,(Xâˆ’Z)r /aZ â†’ (X âˆ’ Z)r
and the Geometric Satake sheaves descend to ShtG,(Xâˆ’Z)r /aZ , which in an effort to curtail increasingly
monstrous notation we continue to denote by SatShtG,(Xâˆ’Z)r (Âµ1 , . . . , Âµr ). Furthermore, we still have:
Proposition 4.19 ([Ngo06] Â§1.4 Corollaire 2). The shifted perverse sheaf SatShtG ,(Xâˆ’Z)r (Âµ1 , . . . , Âµr ) restricted to ShtG,(X â—¦ )r /aZ is locally acyclic with respect to the map
Ï€ : ShtG,(X â—¦ )r /aZ â†’ (X â—¦ )r .
We now prepare to state the properness result for the morphism ShtG,(X â—¦ )r /aZ â†’ (X â—¦ )r . We can write
any Âµ âˆˆ Xâˆ— (T )+ as
Âµ = Âµ+ âˆ’ Âµâˆ’
where
+
Âµ+ := (Âµ+
1 â‰¥ . . . â‰¥ Âµr â‰¥ 0)
âˆ’
Âµâˆ’ := (0 â‰¥ Âµâˆ’
1 â‰¥ . . . â‰¥ Âµr )

We define
||Âµ|| := max(|Âµ+ |, |Âµâˆ’ |).

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

15

Proposition 4.20 ([Ngo06] Â§1.6 Proposition 2). Let (Âµ1 , . . . , Âµr ) âˆˆ (Xâˆ— (T )+ )r . Suppose that the locus Z of
ramification points of D satisfies
#Z â‰¥ n2 (||Âµ1 || + . . . + ||Âµr ||).
Then the morphism
â‰¤(Âµ ,...,Âµr )

Ï€ â—¦ : ShtG,(X1â—¦ )r

/aZ â†’ (X â—¦ )r

is proper.
We need to extend this result to our integral model X âˆ’ Z = X â—¦ âˆª {x0 }.
Proposition 4.21. Let (Âµ1 , . . . , Âµr ) âˆˆ (Xâˆ— (T )+ )r . Suppose that the locus Z of ramification points of D
satisfies
#Z â‰¥ n2 (||Âµ1 || + . . . + ||Âµr ||).
Then the morphism
â‰¤(Âµ ,...,Âµ )

1
r
Ï€ : ShtG,(Xâˆ’Z)
/aZ â†’ (X âˆ’ Z)r
r

is proper.
Proof. Let G be the group scheme isomorphic to G at places away from x0 but hyperspecial at x0 . Then
Proposition 4.20 applied to ShtG shows that
â‰¤(Âµ ,...,Âµ )

1
r
Z
Ï€ â€² : ShtG,(Xâˆ’Z)
â†’ (X âˆ’ Z)r
r /a

is proper. The map G â†’ G induces a projection
â‰¤(Âµ ,...,Âµ )

â‰¤(Âµ ,...,Âµ )

1
r
1
r
Z
pr : ShtG,(Xâˆ’Z)
/aZ â†’ ShtG,(Xâˆ’Z)
r
r /a

which we claim is proper. It obviously suffices to prove the claim. For that we consider the commutative
diagram below, omitting some subscripts and superscripts, etc. for clarity of presentation.
ShtG

BunG
Id Ã— Frob

HeckeG

hâ† Ã—hâ†’

BunG Ã— BunG
ShtG

BunG
Id Ã— Frob

HeckeG

hâ† Ã—hâ†’

BunG Ã— BunG

In this diagram the squares with solid arrows are cartesian. Let Heckeâ€²G and Shtâ€²G denote the fibered products
hâ† Ã—hâ†’

Heckeâ€²G
HeckeG

hâ† Ã—hâ†’

BunG Ã— BunG
BunG Ã— BunG

and
Shtâ€²G

BunG
Id Ã— Frob

Heckeâ€²G

h

â†

Ã—h

.

â†’

BunG Ã— BunG
â‰¤(Âµ1 ,...,Âµr )

The map BunG â†’ BunG is proper, hence so is pullback Heckeâ€²G â†’â†’ HeckeG . Since the map HeckeG
â‰¤(Âµ ,...,Âµ )

â†’

â€²â‰¤(Âµ ,...,Âµ )

r
r
is also proper, hence so is the compoâ†’ ShtG 1
(Heckeâ€²G )â‰¤(Âµ1 ,...,Âµr ) is proper, the map ShtG 1
sition
â‰¤(Âµ1 ,...,Âµr )
â‰¤(Âµ1 ,...,Âµr ) pr
â‰¤(Âµ ,...,Âµr )
âˆ’â†’ ShtG
.
â†’ (Shtâ€²G )
ShtG 1



16

TONY FENG

5. The Kottwitz Conjecture for shtukas
5.1. Parahoric Hecke algebras. Let G be a split reductive group over a non-archimedean local field Ft
with uniformizer t. (The splitness assumption is not necessary, but is certainly adequate for our eventual
purposes and simplifies the notation significantly.)
5.1.1. Spherical Hecke algebra. Let K be a hyperspecial maximal compact subgroup of G(Ft ). By BruhatTits theory we may extend G to an integral model over the valuation subring Ot âŠ‚ Ft such that G(Ot ) = K.
Let HG,K = Func (K\G(Ft )/K, Qâ„“ ) be the corresponding spherical Hecke algebra. This has several
canonical bases, so we fix notation for them. Let T âŠ‚ G be a maximal split torus. As is well known, we have
a Cartan decomposition
[
KtÂµ K
(5.1)
G(Ft ) =
ÂµâˆˆXâˆ— (T )+

indexed by the dominant coweights Xâˆ— (T )+
Ï‡ âˆˆ X âˆ— (T ), we have Ï‡(tÂµ ) = thÏ‡,Âµi .

âˆ¼
= Zn , where tÂµ is the character such that for a character

Definition 5.1. For Âµ âˆˆ Xâˆ— (T )+ , we denote by fÂµ âˆˆ HG,K the indicator function of KtÂµ K.
5.1.2. Geometrization of spherical Hecke algebra. A second basis is obtained by interpreting categorifying
the Hecke algebra in terms of L+ G-equivariant perverse sheaves on the affine Grassmannian GrG . Recall
that GrG (kt ) = G(Ft )/G(Ot ) where kt is the residue field of Ft . Geometric Satake furnishes a symmetric
monoidal equivalence
b
PervG(Ot ) (GrG ) âˆ¼
= Rep(G).
b are indexed by Âµ âˆˆ Xâˆ— (T )+ , and we denote by SatGr (Âµ) the corresponding
The simple objects in Rep(G)
G

perverse sheaf on GrG , which is the IC sheaf of the Schubert variety Grâ‰¤Âµ
G .
For any F âˆˆ PervG(Ot ) (GrG ), we have under the function-sheaf dictionary ([KW01] Â§III.12) a trace
function fF on G(Ot )\G(Ft )/G(Ot ) given by
fF (x) = Tr(Frob, Fx ).

(5.2)

Definition 5.2. We define ÏˆÂµ to be the trace function associated to SatGrG (Âµ).
Definition 5.3. Since SatGrG (Âµ) is a G(Ox0 )-equivariant sheaf on GrG,x0 , its stalks are the same on any
open Schubert cell Gr=Î½ corresponding to KtÎ½ K in the Cartan decomposition (5.1). We denote this common
stalk by SatGrG (Âµ)Î½ .
Lemma 5.4. We have
ÏˆÂµ =

X

Tr(Frob, SatGrG (Âµ)Î½ )fÎ½

Î½â‰¤u

Proof. This is immediate from the fact that SatGr (Âµ)Î½ is supported on Grâ‰¤Âµ , which is the union of the Gr=Î½
for Î½ â‰¤ Âµ, and the definition of fÎ½ as the characteristic function on KtÎ½ K.

We have a Satake isomorphism
âˆ¼
b âˆ¼
HG (K) âˆ’
â†’ R(G)
= Qâ„“ [Xâˆ— (T )]W

b is the represenwhere W is the Weyl group of T . (The Satake isomorphism is reviewed in Â§7.2.) Here R(G)
b which is generated by the classes of the highest weight representations VÂµ .
tation ring of G,

5.1.3. Parahoric Hecke algebras. Let J be a parahoric subgroup of G stabilizing a facet in the dominant alcove
of the vertex corresponding to K in the Bruhat-Tits building of G(Ft ). Let HG,J = Func (J\G(Ft )/J, Qâ„“ )
be the corresponding parahoric Hecke algebra.
Theorem 5.5 (Bernstein, [Hai09] Theorem 3.1.1.). Convolution with f0 = IK (the identity of HG,K ) induces
an isomorphism
âˆ¼
âˆ’ âˆ—J IK : Z(HG,J ) âˆ’
â†’ HG,K .
Definition 5.6. For Âµ âˆˆ Xâˆ— (T )+ ,
â€¢ We denote by fÂµâ€² the unique element of Z(HG,J ) such that fÂµâ€² âˆ— IK = fÂµ .
â€¢ We denote by ÏˆÂµâ€² âˆˆ Z(HG,J ) the unique element such that ÏˆÂµâ€² âˆ— IK = ÏˆÂµ âˆˆ HG,K .

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

17

5.1.4. Geometrization of parahoric Hecke algebras. There is a geometrization of the parahoric Hecke algebra
completely analogous to Â§5.1.2. Let G be the parahoric group scheme corresponding to J by Bruhat-Tits
theory. Then the Hecke algebra HG,J is categorified by PervG(O) (GrG ).
Note that if J = I is an Iwahori subgroup (the stabilizer of full alcove), then GrG is the affine flag variety
FlG . In general one can think of GrG as a kind of affine partial flag variety.
One might ask which sheaves the functions ÏˆÂµâ€² correspond to. The answer is that they can be realized as
nearby cycles of certain global degenerations, and it is the key point underlying this section.
5.2. Nearby cycles. We recall the definition and essential (for us) properties of the nearby cycles functor.
For a reference, see [Del73] ExposÃ© XIII.
A Henselian trait is a triple (S, s, Î·) where S is a the spectrum of a discrete valuation ring, s is the special
point of S and Î· is the generic point of S. Choose geometric points s and Î· lying over s and Î·, respectively.
Let S be the normalization of S in Î·. We denote by
i : s Ö’â†’ S
j : Î· Ö’â†’ S
i: s â†’ S
j: Î· â†’ S
the obvious maps.
Let f : Y â†’ S be a finite type scheme over S. One defines a topos Y Ã—s Î· as in [Del73] ExposÃ© XIII
Â§1.2, so that the category Dcb (Y Ã—s Î·, Qâ„“ ) is the category of F âˆˆ Dcb (Y Ã—s s, Qâ„“ ) together with a continuous
Gal(Î·/Î·)-action compatible with the Gal(s/s)-action on Ys via the natural map Gal(Î·/Î·) â†’ Gal(s/s).
Definition 5.7. Given F âˆˆ Dcb (YÎ· , Qâ„“ ) we define the nearby cycles RÎ¨(F ) âˆˆ Dcb (Y Ã—s s, Qâ„“ ) by
âˆ—

RÎ¨(F ) := i Rj âˆ— (FÎ· )
with the Gal(Î·/Î·)-action obtained by transport of structure from that on FÎ· .
Remark 5.8. When the nearby cycles construction is performed with S = Spec Fq [[t]], the sheaf RÎ¨(F )
is a priori only defined over YFq , but can be descended to YFq by choosing a splitting Gal(Fq /Fq ) â†’
Gal(Fq ((t))/Fq ((t))). When dealing with nearby cycles on affine Grassmannians (or related objects) this is
often what we mean (see [Gai01], Footnote 4 on page 8). Only after such a descent one can associate a trace
function to RÎ¨(F ). We shall point out when this descent is being used, but as a blanket rule it is necessary
every time we wish to talk about a trace function.
Lemma 5.9. If f : Y â†’ S is proper, then the base change homomorphism
RÎ¨fâˆ— â†’ fâˆ— RÎ¨
is an isomorphism.
Proof. This is [Del73], ExposÃ© XIII (2.1.7.1).



Corollary 5.10. If f : Y â†’ S is proper, then the natural map
Hci (YÎ· , Qâ„“ ) â†’ Hci (Ys , RÎ¨(Qâ„“ )).
is an isomorphism.
Lemma 5.11. If f : Y â†’ S is lisse, then the base change homomorphism
f âˆ— RÎ¨ â†’ RÎ¨f âˆ—
is an isomorphism.
Proof. This is [Del73], ExposÃ© XIII (2.1.7.2).



18

TONY FENG

5.3. Degeneration to affine flag varieties. Let X be a smooth curve (not necessarily projective) over Fq
and let G â†’ X be a parahoric group scheme, with parahoric level structure at x0 . We consider the global
affine Grassmannian for G as in Â§4.1:
Ï€ : GrG â†’ X.
Consider the restriction GrG |Dx0 , where Dx0 := Spec Ox0 is the spectrum of the completed local ring at x0 .
We apply the nearby cycles construction of Â§5.2 and in the form of Remark 5.8, to
â€¢ S = Dx0 , Y = GrG |Dx0 , and
â€¢ F = SatGrG (Âµ)|Dxâˆ—0 , where Dxâˆ—0 = Spec Fx0 is thought of as a local â€œpunctured diskâ€ around x0 .
This produces a G(Ox0 )-equivariant perverse sheaf RÎ¨(SatGrG (Âµ)|Dxâ—¦0 ) on GrG |x0 , which we will abbreviate
by RÎ¨(SatGrG (Âµ)).
Theorem 5.12 (Gaitsgory [Gai01], Zhu [Zhu14]). The sheaf RÎ¨(SatGrG (Âµ))) is central.
Remark 5.13. In the present formulation and level of generality, this theorem is actually due to X. Zhu in
[Zhu14] Theorem 7.3. Gaitsgory worked with constant group schemes G, and a slightly different degeneration.
Corollary 5.14. Assume that G := G|Fx0 is split. Then the trace function (in the sense of (5.2)) associated
to RÎ¨(SatGrG (Âµ))) is ÏˆÂµâ€² (Definition 5.6).
Remark 5.15. Note that we need to use Remark 5.8 to descend RÎ¨(SatGrG (Âµ))) to GrG |x0 , so that it
makes sense to speak of the trace function.
Proof. Since RÎ¨(SatGrG (Âµ)) is a G(Ox )-equivariant perverse sheaf on GrG |x0 , which is central by Theorem
5.12, we have a priori that its trace function
Tr(Frob, RÎ¨(SatGrG (Âµ)))
lies in Z(HG,G(Ox0 ) (Fx )). Since G is split we can extend it to a constant group scheme over Dx0 , which we
continue to denote G, such that G0 (Ox0 ) =: K is a hyperspecial maximal compact subgroup of G(Fx ). Write
also J := G(Ox0 ) for the parahoric subgroup. By the Bernstein isomorphism (Theorem 5.5)
âˆ¼

âˆ’ âˆ— IK : Z(HG,J ) âˆ’
â†’ HG,K
it suffices to check that
Tr(Frob, RÎ¨(SatGrG (Âµ))) âˆ— IK = ÏˆÂµ .
(5.3)
By [Gai01] Theorem 1 (d) the map (5.3) is realized sheaf-theoretically by the pushforward via the proper
map
pr : GrG â†’ GrG
or in other words,
Tr(Frob, RÎ¨(SatGrG (Âµ))) âˆ— IK = Tr(Frob, pr! RÎ¨(SatGrG (Âµ))).
Now, by Lemma 5.9 and the fact that pr is an isomorphism over Dxâˆ—0 (since G|Dxâˆ—0 âˆ¼
= G|Dxâˆ—0 ) we have
pr! RÎ¨(SatGrG (Âµ)) = RÎ¨(SatGrG (Âµ))
but since G0 |Dx â†’ Dx is smooth with constant fiber GrG , we simply have
RÎ¨(SatGrG (Âµ)) = SatGrG (Âµ)|x0 ,
whose trace function is ÏˆÂµ by definition.



Schubert stratification. Let GrG,x0 be the fiber of GrG over x0 . We discuss the stratification induced by the
G(Ox0 )-action on GrG,x0 .
The analogue of the Cartan decomposition (5.1) is
fJ \W
f /W
fJ
G(Ox0 )\G(Fx0 )/G(Ox0 ) âˆ¼
=W

f is the extended affine Weyl group, and W
fJ is the subgroup corresponding to the parahoric subgroup
where W
J := G(Ox0 ). We refer to [Hai09] Â§2.6 for the notation and definitions; all that we require are the following
abstract facts:
fJ \W
f /W
fJ . We denote the open orbit corresponding
â€¢ The G(Ox0 )-orbits on GrG,x0 are indexed by Î½ âˆˆ W
â‰¤Î½
=Î½
fJ \W
f /W
fJ by GrG,x and its closure by Gr
to Î½ âˆˆ W
G,x0 .
0

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

19

fJ \W
f /W
fJ such that Âµ â‰¥ Î½ if and only if Grâ‰¤Âµ âŠƒ Gr=Î½ .
â€¢ There is a partial order on W
G,x0
G,x0

Definition 5.16. Since RÎ¨(SatGrG (Âµ)) is a J-equivariant perverse sheaf on GrG,x0 ([Gai01] Theorem 1), its
stalks are the same on any open Schubert cell Gr=Î½
G . We denote this common stalk by RÎ¨(SatGr (Âµ))Î½ .
Lemma 5.17. We have
ÏˆÂµâ€² =

X

Tr(Frob, RÎ¨(SatGrG (Âµ))Î½ )fÎ½

Î½â‰¤Âµ

Proof. The argument is the same as for Lemma 5.4.



5.4. Local models for shtukas.
Definition 5.18. Let X and Y be Artin stacks. We say that Y is an Ã©tale local model for X if there exists
an Artin stack W and a diagram
W
Ã©tale

Ã©tale
g

f

X

Y

A diagram as above is called a local model diagram.
â‰¤(Âµ ,...,Âµr )

Theorem 5.19 (Varshavsky, V. Lafforgue). The stack GrG,X1r

â‰¤(Âµ1 ,...,Âµr )

is an Ã©tale local model for ShtG

.

Remark 5.20. This is a variation on well-known results, which are not quite stated in the literature at
the level of generality needed here. Varshavsky proved this ([Var04] Theorem 2.20) for a constant group
G = G Ã— X, while the general case is essentially implicit in [Laf12], so we credit it to both of them.
Proof. For ease of presentation, we assume that r = 1 in the proof; the argument for the general case is
a completely straightforward generalization. Since for any given Âµ the L+ G-action on Heckeâ‰¤Âµ
and Grâ‰¤Âµ
G
G
factors through a finite Ã©tale quotient, Proposition 4.8 implies that there is an Ã©tale cover Heckeâ‰¤Âµ
G,N â†’
â‰¤Âµ
â‰¤Âµ
â‰¤Âµ
HeckeG , obtained by adding a finite level structure, equipped with an Ã©tale map HeckeG,N â†’ GrG Ã— BunG .
â‰¤Âµ
Define ShtG,N
by the cartesian diagram
Shtâ‰¤Âµ
G,N

BunG
Id Ã— Frob

hâ† Ã—hâ†’
Heckeâ‰¤Âµ
BunG
G,N

Ã— BunG

â‰¤Âµ
Then we have a finite Ã©tale cover Shtâ‰¤Âµ
G,N â†’ ShtG , which concretely is the covering map for a finite level
structure. This fits into a diagram

Shtâ‰¤Âµ
G,N

BunG

Ã©tale

Shtâ‰¤Âµ
G

Id Ã— Frob

Heckeâ‰¤Âµ
G,N

h

â†

Ã—h

â†’

BunG Ã— BunG

(5.4)

Ã©tale

BunG Ã— Grâ‰¤Âµ
G
â‰¤Âµ
It is a general fact that in this situation that the vertical composition Shtâ‰¤Âµ
G,N â†’ GrG is Ã©tale. Indeed, since
the claim is local in the smooth topology, we may perform a base change to make everything into a scheme,
â‰¤Âµ
and apply [Laf12] Lemma 2.13 to W = Heckeâ‰¤Âµ

G,N , T = GrG , and Z = BunG .

20

TONY FENG

Corollary 5.21. Let Âµ âˆˆ Xâˆ— (T )r . There is an Ã©tale local model diagram
W â‰¤Âµ
Ã©tale

Ã©tale
g

f
â‰¤Âµ

â‰¤Âµ

ShtG

GrG
Xr

with
f âˆ— SatShtG (Âµ) = g âˆ— SatGrG (Âµ).
â‰¤Âµ

Proof. This follows from the diagram (5.4) and the definition of the Satake sheaves, taking W â‰¤Âµ = ShtG,N .

Let Âµ âˆˆ Xâˆ— (T )r . By Corollary 5.21, we may set
SatW (Âµ) := f âˆ— SatShtG (Âµ) = g âˆ— SatGrG (Âµ).
We write RÎ¨x0 to emphasize that we are taking nearby cycles over the point x0 . By Lemma 5.11, and
implicitly using Corollary 5.21, we have
f âˆ— RÎ¨x0 (SatShtG (Âµ)) = RÎ¨x0 (SatW (Âµ)) = g âˆ— RÎ¨x0 (SatGrG (Âµ)).
Thus, for w âˆˆ W(k) lying over y âˆˆ ShtG (k) and z âˆˆ GrG (k), we have
Tr(Frob, RÎ¨x0 (SatShtG (Âµ))y ) = Tr(Frob, RÎ¨x0 (SatW (Âµ))w ) = Tr(Frob, RÎ¨x0 (SatGrG (Âµ))z ).
Therefore, the stalks of RÎ¨x0 (SatShtG (Âµ)) are constant along the stratification
a
â‰¤Âµ
=Î½
ShtG =
ShtG ,
Î½â‰¤Âµ

and we deduce:
Corollary 5.22. For Î½ âˆˆ Xâˆ— (T )+ , we have
Tr(Frob, RÎ¨x0 (SatShtG (Âµ))Î½ ) = Tr(Frob, RÎ¨x0 (SatGrG (Âµ))Î½ ).
Remark 5.23. We will actually need to work with ShtG /aZ instead. Since this is obtained from ShtG by
gluing isomorphic components, the result is exactly the same.
6. Counting parahoric shtukas
Our eventual goal is establish a formula for the trace of an operator, formed as a composition of Hecke
operators and Frobenius, on the cohomology of the nearby cycles sheaf of (a variant of) ShtG /aZ â†’ X, at
a place of parahoric bad reduction. The mold for such calculations was set by Kottwitz in [Kot92], who
computed this sort of trace for certain PEL Shimura varieties, at places of good (hyperspecial) reduction. It
has since been extended vastly by work of many authors; we note that in particular that Kisin and Pappas
constructed integral models for Shimura varieties with parahoric level structure and computed the trace of
Frobenius on nearby cycles in [KP]. Our result is a function field analogue of this computation.
In this section we carry out one step of this calculation, which deals with counting the number of fixed
points of Frobenius composed with Hecke correspondences. (The precise setup will be explained in Â§6.1.) In
fact most of the work has already been done by B.C. NgÃ´ and T. NgÃ´ Dac, who studied the case of moduli
of shtukas with hyperspecial reduction in the series of papers [Ngo06], [NND08], [ND13], and [ND15]. The
only new element here is that we are considering parahoric reduction. We note also that our results should
follow from work of Hartl and Arasteh Rad proving the analogue of the Langlands-Rapoport Conjecture for
shtukas [HRb].

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

21

6.1. Setup. Throughout this section X â—¦ is an unspecified open subset X, which in the case of D-shtukas
will be X âˆ’ Z where Z is the set of ramification places of D. We let G be a quasi-split, connected reductive
group over F with simply-connected derived group, or the group attached to a division algebra D as in Â§4.5.
(This unwieldy hypothesis is in place because the statements of [NND08] and [ND13] use the first general
hypothesis, but apply also D-shtukas, cf. [Ngo06] Â§4, and we are also interested in the latter.) Let G â†’ X a
parahoric group scheme, with parahoric reduction at x0 .
Let Kv = G(Ov ). Let Kv tÎ²v Kv âˆˆ Kv \G(Fv )/Kv be a choice of double coset for all v, trivial for almost
all v. Let T â€² âŠ‚ X â—¦ be the set of all v where Î²v 6= 0, i.e. where the corresponding Hecke operator hÎ²v is not
the identity. We assume that Kv is hyperspecial for all v âˆˆ T â€² .
There is a Hecke correspondence (Â§4.3.4)
v
/aZ
Hecke(ShtG )â‰¤Î²
v

h

â†

hâ†’

ShtG /aZ

ShtG /aZ
Ï€

(6.1)

Ï€

X
for each Î²v . This induces a Hecke operator hÎ²v on the cohomology of ShtG /aZ (Definition 4.14). See [NND08]
Â§3 for more discussion about the Hecke correspondences.
Q
We abbreviate Î² := (Î²v )vâˆˆT â€² and denote the corresponding Hecke operator hÎ²v by hÎ²,T â€² . We want to
compute (a variant of)
Tr(hÎ²,T â€² â—¦ Frob, Ï€! RÎ¨x0 (SatShtG (Âµ)))
where x0 is our fixed place of parahoric reduction. By the Grothendieck-Lefschetz trace formula, we have
Tr(hÎ²,T â€² â—¦ Frob, RÎ¨x0 (SatShtG (Âµ)))
X
=

ÎâˆˆFix(hÎ²,T â€² â—¦Frob)

1
Tr(hÎ²,T â€² â—¦ FrobÎ , RÎ¨x0 (SatShtG (Âµ))Î ).
# Aut Î

We will compute this by focusing first on counting Fix(Î¦Î²,T â—¦ Frob). This was done by [Ngo06] for Dshtukas at points of with no level structure (good reduction), and extended by [NND08] for general reductive
groups and [ND13] for more complicated setups; however, these counts only account for the contribution
from the â€œelliptic partâ€.
In the case where GF is anisotropic mod center, the elliptic part will obviously compose everything. This
is one of the reasons why it is convenient to work with division algebras, and one of the difficulties in carrying
out the strategy for general groups. Since ShtG is of infinite type in general, it will have infinitely many
points even over finite fields, although the sum can still converge because of the weighting of automorphisms.
6.2. The groupoid of fixed points. We consider a slightly more general situation. Weâ€™ll define a groupoid
C(Î±, Î²; T, T â€² ; d) which occurs as the fixed points of a composition of Hecke and Frobenius operators on a
certain moduli stack of shtukas. Then we will count its mass in the sense of groupoids.
Definition 6.1. If C is a finite groupoid with finite automorphism groups then we define
X
1
#C :=
.
# Aut(c)
câˆˆC

Note that the Fq -points of a finite type Deligne-Mumford stack, which includes any Schubert cell in a moduli
stack of shtukas, satisfies this assumption.
Definition 6.2 ([NND08] Â§4). Let T, T â€² âŠ‚ |X| âˆ’ I. Let
Î± = (Î±v âˆˆ Kv \G(Fv )/Kv )vâˆˆT
Î² = (Î²v âˆˆ Kv \G(Fv )/Kv )vâˆˆT â€²

(In terms of the notation of Â§6.1, we are identifying Î²v with Kv tÎ²v Kv .) We define the groupoid of fixed
points C(Î±, Î²; T, T â€² ; d) as follows: its objects are triples (E, t, tâ€² ) with
âˆ¼
â†’ E|Xâˆ’T , with modification type Î± on T , and
(1) t : E Ïƒ |Xâˆ’T âˆ’

22

TONY FENG
d

âˆ¼

â†’ E|Xâˆ’T â€² , with modification type Î² on T â€² ,
(2) tâ€² : E Ïƒ |Xâˆ’T â€² âˆ’
(3) satisfying the following compatibility:
EÏƒ

d+1

Ïƒd (t)

|Xâˆ’T âˆ’T â€²

d

E Ïƒ |Xâˆ’T âˆ’T â€²

Ïƒ(tâ€² )

tâ€²
t

E Ïƒ |Xâˆ’T âˆ’T â€²

E|Xâˆ’T âˆ’T â€²

The automorphisms of (E, t, tâ€² ) are defined to be automorphisms of E commuting with t and tâ€² .
The relation to our initial problem is given by the following.
Lemma 6.3. Suppose x âˆˆ |X| is a point of degree d. Then we have an isomorphism of groupoids
Fix(hÎ²,T â€² â—¦ Frob, Sht=Âµ |x ) âˆ¼
= C(Âµ, Î²; {x}, T â€² ; d).
G

Proof. This is immediate upon writing down the definitions.



Sht=Âµ
G

We actually want to study the truncated space
/aZ , so we modify the discussion accordingly. Let
J âŠ‚ Z(G)(A) be a cocompact lattice. Then J acts on Sht=Âµ
via Hecke correspondences, and we define
G
â€²
Sht=Âµ
G /J to be the quotient. Similarly we define C(Âµ, Î²; {x}, T ; d)J to be the quotient by the J-action. (See
[NND08], near the end of Â§4, for more details.)
Lemma 6.4. Suppose x âˆˆ |X| is a point of degree d. Then we have an isomorphism of groupoids
âˆ¼ C(Âµ, Î²; {x}, T â€²; d)J .
Fix(hÎ²,T â€² â—¦ Frobx , Sht=Âµ /J|x ) =
G

â€²

Hence we want to study #C(Âµ, Î²; {x}, T ; d)J . The strategy for these counts goes back to Kottwitzâ€™s study
of points of Shimura varieties (with hyperspecial level structure) over finite fields [Kot92].
(1) We first show that there is a cohomological invariant, the Kottwitz invariant, which controls the
possible â€œgeneric fibersâ€ of members of C(Î±, Î²; T, T â€² ; d).
(2) We then express the size of an isogeny class as a product of (twisted) orbital integrals.
(3) We then express the number of isogeny classes associated to each Kottwitz invariant in terms of
certain cohomology groups.
These steps have been carried out in papers of B.C. NgÃ´ and T. NgÃ´ Dac, as already mentioned, but not
quite in the generality required here. In particular, these previous papers avoid the case where T meets a
point with non-trivial level structure (because the moduli problem was not defined over such points), which
is exactly the situation that we are interested in. So we will describe the modifications needed to extend
the argument to our setting, and only briefly summarize the parts that are already covered in the papers of
B.C. NgÃ´ and T. NgÃ´ Dac.
6.3. Kottwitz triples and classification of generic fibers. Our first step is to define a category that
looks like the category of â€œgeneric fibers of C(Î±, Î²; T, T â€² ; d)â€.
Definition 6.5 ([NND08] Â§5). Let T, T â€² âŠ‚ |X| âˆ’ I. We define the groupoid C(T, T â€² ; d) as follows: its objects
are triples (V, Ï„, Ï„ â€² ) with
(1) V a G-torsor over Fk := F âŠ—k k,
âˆ¼
(2) an isomorphism Ï„ : V Ïƒ âˆ’
â†’ V , where V Ïƒ = V âŠ—Fk ,Ïƒ Fk ,
d âˆ¼
â†’V,
(3) Ï„ â€² : V Ïƒ âˆ’
satisfying the following conditions:
(1) (â€œcommutativityâ€) The following diagram commutes:
VÏƒ

d+1

Ïƒd (Ï„ )

Ïƒ(Ï„ â€² )

VÏƒ

VÏƒ

d

Ï„â€²
Ï„

E

b Fq Ïƒ).
b Fq Fq ), Id âŠ—
(2) For x âˆˆ
/ T , (Vx , Ï„x ) is isomorphic to the trivial isocrystal (G(Fx âŠ—
b Fq Fq ), Id âŠ—
b F d Ïƒ d ).
(3) For x âˆˆ T , (Vx , Ï„xâ€² ) is isomorphic to the trivial isocrystal (G(Fx âŠ—
q

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

23

The automorphisms of (V, Ï„, Ï„ â€² ) are automorphisms of E commuting with Ï„ and Ï„ â€² .
The operation of â€œtaking the generic fiberâ€ defines a functor ([NND08] Â§5.2)
C(Î±, Î²; T, T â€² ; d) â†’ C(T, T â€² ; d).
6.3.1. Kottwitz triples. Recall that a Kottwitz triple is a datum (Î³0 , (Î³x )xâˆˆT
/ , (Î´x )xâˆˆT ) where:
â€¢ Î³0 is a stable conjugacy class of G(F ),
â€¢ Î³x is a conjugacy class of G(Fx ) for each x âˆˆ
/ T , and is stably conjugate to Î³0 ,
b Fq Fqd ), whose norm
â€¢ Î´x is a Ïƒ-conjugacy class of G(Fx âŠ—
N (Î´x ) := Î´x Â· Ïƒ(Î´x ) Â· . . . Â· Ïƒ dâˆ’1 (Î´x )

is stably conjugate to Î³0 .

Construction 6.6. We now recall from [NND08] Â§6.1 how to attach to each (V, Ï„, Ï„ â€² ) âˆˆ C(T, T â€² ; d) a
Kottwitz triple (Î³0 , (Î³x )xâˆˆT
/ , (Î´x )xâˆˆT ).
n
First a remark on notation: for a map Ï„ : V Ïƒ â†’ V , we denote by Ï„ n : V Ïƒ â†’ V the map Ï„ â—¦ Ïƒ(Ï„ ) â—¦ . . . â—¦
Ïƒ nâˆ’1 (Ï„ ).
(1) Definition of Î³0 . Since Fk has cohomological dimension 1, the G-torsor V is split over Fk . Consider
Î³ = Ï„ d (Ï„ â€² )âˆ’1 , which is a linear automorphism of V . Using the â€œcommutativityâ€ axiom we find that
Ïƒ(Î³) = Ïƒ(Ï„ ) â—¦ Ïƒ 2 (Ï„ ) â—¦ . . . â—¦ Ïƒ d (Ï„ ) â—¦ Ïƒ(Ï„ â€² )âˆ’1 = Ï„ âˆ’1 Î³Ï„.
This shows that the conjugacy class of Î³ is stable under Ïƒ, hence defined over F . Since G was
assumed to be quasi-split with simply connected derived subgroup, this conjugacy class must then
contain an F -point. Thus, we have an element Î³0 âˆˆ G(F ) with a well-defined stable conjugacy class.
(2) Definition of Î³x , x âˆˆ
/ T . By assumption, we can pick an isomorphism
b F Ïƒ).
b F Fq ), Id âŠ—
(Vx , Ï„x ) âˆ¼
= (G(Fx âŠ—
q

q

b Fq Fq ), Id âŠ—
b Fq Ïƒ).
Since Ï„ and Ï„ commute, so do Ï„x and
so that defines an automorphism of (G(Fx âŠ—
We can then write Ï„xâ€² = Î³xâˆ’1 âŠ— Ïƒ d , for some Î³x âˆˆ G(Fx ) which is stably conjugate to Î³0 . (The point
is that picking this trivialization of Ï„x amounts to setting â€œÏ„x = Idâ€ in the equation Î³x = Ï„xd (Ï„xâ€² )âˆ’1 .)
(3) Definition of Î´x , x âˆˆ T . By assumption, we can pick an isomorphism
b Fd Ïƒ d ).
b F Fq ), Id âŠ—
(Vx , Ï„ â€² ) âˆ¼
= (G(Fx âŠ—
â€²

Ï„xâ€² ,

x

Ï„xâ€²

q

q

b Fq Fq ), Id âŠ—
b Fq Ïƒ).
Since Ï„ and Ï„ â€² commute, so do Ï„x and Ï„xâ€² , so that Ï„x defines an automorphism of (G(Fx âŠ—
We can then write Ï„x = Î´x âŠ— Ïƒ, for some Î´x âˆˆ G(Fx ), well-defined up to Ïƒ-conjugacy, whose norm
N (Î´x ) = Î´x Â· Ïƒ(Î´x ) Â· . . . Â· Ïƒ râˆ’1 (Î´x ) is stably conjugate to Î³0 .

Definition 6.7. We say that (V, Ï„, Ï„ â€² ) âˆˆ C(T, T â€² ; d) is semisimple if Î³0 is semisimple, and elliptic if Î³0 is
elliptic.
We say (E, t, tâ€² ) âˆˆ C(Î±, Î²; T, T â€² ; d) is semisimple (resp. elliptic) if the associated (V, Ï„, Ï„ â€² ) is semisimple
(resp. elliptic).
6.3.2. The Kottwitz invariant. Following [NND08] Â§6.2 we can attach to the Kottwitz triple (Î³0 , (Î³x ), (Î´x ))
b Î³0 )Î“ ). Briefly, this is done as follows.
a character inv(Î³0 , (Î³x ), (Î´x )) âˆˆ X âˆ— (Z(G
b k k)
â€¢ For x âˆˆ
/ T , since Î³x and Î³0 are stably conjugate, by a theorem of Steinberg we can find g âˆˆ G(Fx âŠ—
such that
gÎ³0 g âˆ’1 = Î³x .
Then (using that Î³0 âˆˆ G(F )) we have
gÎ³0 g âˆ’1 = Î³x = Ïƒ(Î³x ) = Ïƒ(g)Î³0 Ïƒ(g)âˆ’1 .
b k k), hence defines a class in B(GÎ³0 ,x ) =
This shows that g âˆ’1 Ïƒ(g) is in the centralizer of Î³0 in G(Fx âŠ—
b k k)/Ïƒ-conjugacy.
G(Fx âŠ—
b k k) and
b k k) such that N Î´x = gÎ³0 g âˆ’1 . Then g âˆ’1 Î´x Ïƒ(g) is in GÎ³0 (Fx âŠ—
â€¢ For x âˆˆ T , we have g âˆˆ G(Fx âŠ—
defines a class in B(GÎ³0 ,x ).

24

TONY FENG

bÎ³0 )Î“x ) of [Kot90] Â§6 to get a local character invx (Î³0 , (Î³x ), (Î´x )) âˆˆ
For each x, we apply the map B(GÎ³0 ,x ) â†’ X âˆ— (Z(G
Î“
âˆ—
bÎ³0 ) x ). Almost all of the resulting characters are trivial, so that it makes sense to sum the restrictions
X (Z(G
b Î³0 )Î“ , and we define this sum to be inv(Î³0 , (Î³x ), (Î´x )).
of all these characters to Z(G
Proposition 6.8. [NND08] For elliptic (V, Ï„, Ï„ â€² ) âˆˆ C(T, T â€² ; d), and (Î³0 , (Î³x ), (Î´x )) the associated Kottwitz
triple, if Î³0 is semisimple then we have inv(Î³0 , (Î³x ), (Î´x )) = 0.

Proposition 6.9. There exists (V, Ï„, Ï„ â€² ) âˆˆ C(T, T â€² ; d) having a given elliptic Kottwitz triple (Î³0 , (Î³x ), (Î´x ))
if and only if inv(Î³0 , (Î³x ), (Î´x )) = 0. If the set of such is non-empty, then the number of isogeny classes
within C(T, T â€² ; d) having the same Kottwitz triple is the cardinality of
Y
ker1 (F, GÎ³0 ) := ker(H 1 (F, GÎ³0 ) â†’
H 1 (Fx , GÎ³0 )).
x

Proof. This follows from the proof of [NND08] Proposition 11.1 combined with [ND13] Proposition 4.3. 
6.3.3. Automorphisms of the generic fiber. Let (V, Ï„, Ï„ â€² ) âˆˆ C(T, T â€² ; d) with elliptic Kottwitz triple (Î³0 , (Î³x ), (Î´x )).
By [ND13] Â§3.9, the automorphisms of (V, Ï„, Ï„ â€² ) are the Fx -points of an inner form JÎ³0 of GÎ³0 defined over
F.
Remark 6.10. As pointed out in [ND13] Â§3.9, the Hasse principle implies that JÎ³0 is determined by its
local components:
â€¢ For x âˆˆ
/ T , JÎ³0 ,x is the centralizer of Î³x in G(Fx ),
â€¢ For x âˆˆ T , JÎ³0 ,x is the twisted centralizer of Î´x in G(Fx âŠ—Fq Fqd ).
6.4. Counting lattices. We now study the fibers of the functor C(Î±, Î²; T, T â€² ; d) â†’ C(T, T â€² ; d).
Proposition 6.11. Fix an elliptic (V, Ï„, Ï„ â€² ) âˆˆ C(T, T â€² ; d). Suppose (E, t, tâ€² ) âˆˆ C(Î±, Î²; T, T â€² ; d) lies over
(V, Ï„, Ï„ â€² ). The size of the isogeny class of (E, t, tâ€² ) is
Y
Y
OÎ³x (Ï†Î²x )
TOÎ´x Ïƒ (Ï†Î±x ).
vol(J Â· JÎ³0 (F )\GÎ³0 (A)) Â·
xâˆˆT

xâˆˆT
/

Here we normalize Haar measures as in Â§2.1.1.
b k k-bundle over Spec Ox for all x âˆˆ X, plus
Proof. Promoting (V, Ï„, Ï„ â€² ) to (E, t, tâ€² ) amounts to choosing a Gx âŠ—
an I-level structure, such that
â€¢
â€¢
â€¢
â€¢

for
for
for
for

vâˆˆ
/ |T |, Ex is fixed by Ï„ ,
vâˆˆ
/ |T |â€² , Ex is fixed by Ï„ â€² ,
x âˆˆ |T |, the relative position of Ex and Ï„ (Ex ) is given by Î±x ,
v âˆˆ |T |â€² (hence outside |T |), the relative position of Ev and Ï„ â€² (Ev ) is given by Î²v .

As is well-known (cf. [NND08] Â§9 or [ND13] Â§5 for the present situation; the earliest reference we know is
[Kot80]), this is counted by
Z
O
O
Ï†Î²x (hâˆ’1
Ï†Î±x (hâˆ’1
x Î³x hx ) dh.
x Î´x Ïƒ(hx ))
Q
JÂ·JÎ³0 (F )\

xâˆˆT

G(Fx âŠ—Fq Fqd )Ã—G(AT ) xâˆˆT

xâˆˆT
/

Here we use Remark 6.10 to view JÎ³0 (F ) as a subset of G(Fx ). The statement of the proposition is a
straightforward rewriting of this formula.

6.5. Count of elliptic elements. Define
#C(Î±, Î²; T, T â€² ; d)ell :=

X

(E,t,tâ€² ) elliptic

1
.
# Aut(E, t, tâ€² )

Combining Proposition 6.9, Â§6.3.3, and Proposition 6.11, we obtain:

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

Theorem 6.12. We have
#C(Î±, Î²; T, T â€² ; d)ell =

X

25

ker1 (F, GÎ³0 ) Â· vol(J Â· JÎ³0 (F )\JÎ³0 (AF )) Â· dg(K)âˆ’1

(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0
Î³0 elliptic

Â·

Y

!

OÎ³x (fÎ²v )

xâˆˆT
/

Y

TOÎ´x Ïƒ (fÎ±x )

xâˆˆ|T |

Remark 6.13. This is the analogue of [ND13] ThÃ©orÃ¨me 5.1. The expressions look almost the same, but
one should keep in mind that in our applications T = {x0 }, and fÎ±x0 should be thought of as an indicator
function on a partial affine flag variety rather than an affine Grassmannian. In addition, the measure of Kx0
is adapted accordingly.
Z
Corollary 6.14. Let Shtâ‰¤Âµ
G /a be the moduli stack of D-shtukas with parahoric level structure at x0 , as in
Â§4.5. Then
X
Z
ker1 (F, GÎ³0 ) Â· vol(aZ Â· JÎ³0 (F )\JÎ³0 (AF ))Â·
# Fix(hÎ²,T â€² â—¦ Frob, Sht=Âµ
G /a |x0 ) =
(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

âˆ’1

Â· dg(K)

Â·

Y

xâˆˆT
/

!

OÎ³x (fÎ²v )

Â· TOÎ´x0 Ïƒ (fÂµ ).

Proof. This is immediate from Lemma 6.4 and the observation that every non-zero element of a division
algebra is elliptic, since the associated group of units is anisotropic mod center. (As mentioned at the
beginning of Â§6, the results used from [NND08] and [ND13] also apply to D-shtukas, and in fact were
originally proved for this case in [Ngo06] Â§4.)

7. Geometrization of base change for Hecke algebras
In this section we present a geometric interpretation of the base change homomorphism for spherical
Hecke algebras, and then for the center of parahoric Hecke algebras. The results here are a generalization
to arbitrary split reductive groups G of results from [Ngo99], which proved the result for GLn .
Using the work of Gaitsgory on realizing central sheaves on the affine flag variety as nearby cycles, we
then deduce a geometric interpretation of base change for the center of the parahoric Hecke algebra.
7.1. Definition of base change homomorphism. For this section only, we let F be a local field and G
be a reductive group over F . Given a compact open subgroup H âŠ‚ G(F ), we have the Hecke algebra
HG,H := Func (H\G(F )/H, Qâ„“ ).
We begin by defining base change homomorphisms for some Hecke algebras with respect to a degree r
unramified extension of local fields E/F .
For simplicity we assume that G is split over F . (Our results should extend at least to quasi-split G
without much difficulty.) We let E/F be the unramified extension of degree r.
Definition 7.1 ([Hai09] Â§1). Let K âŠ‚ G(F ) be a hyperspecial maximal compact subgroup. The base change
homomorphism for spherical Hecke algebras (with respect to E/F ) is the homomorphism of C-algebras
HG(E),K â†’ HG(F ),K
characterized by the following property. Let WF be the Weil group of F . For an admissible unramified
homomorphism Ïˆ : WF â†’ L G let Ïˆ â€² : WE â†’ L G denote the restriction to WE âŠ‚ WF . Let Ï€Ïˆ and Ï€Ïˆâ€² denote
the corresponding representations of G(E) and G(F ) under the Local Langlands Correspondence. Then for
any Ï† âˆˆ HG(E),K we have
htrace Ï€Ïˆâ€² , Ï†i = htrace Ï€Ïˆ , b(Ï†)i
Definition 7.2 ([Hai09] Â§1). Let J âŠ‚ K be a parahoric subgroup and IK denote the characteristic function
of K âŠ‚ G(F ). By a theorem of Bernstein (cf. [Hai09] Theorem 3.1.1), convolution with IK defines an
isomorphism
âˆ¼
âˆ’ âˆ—J IK : Z(HG,J ) âˆ’
â†’ HG,K .

26

TONY FENG

We define the base change homomorphism for parahoric Hecke algebras to be the homomorphism
b : HG(E),J â†’ HG(F ),J
making the following diagram commute:
b

Z(HG(E),J )

Z(HG(F ),J )

âˆ¼ âˆ’âˆ—J IK

âˆ¼ âˆ’âˆ—J IK
b

HG(E),K

(7.1)

HG(F ),K

7.1.1. Interpretation under Satake isomorphism. Let T âŠ‚ G be a maximal torus. We have the Satake
isomorphism
âˆ¼
â†’ Qâ„“ [Xâˆ— (T )]W
S : HG,K âˆ’
where W is the Weyl group of G relative to T . We also have the Bernstein isomorphism
âˆ¼

B : Z(HG,J ) âˆ’
â†’ HG,K .
We can define the base change homomorphism on the Satake side as follows. We define the norm homomorphism
N : Qâ„“ [Xâˆ— (TE )]W â†’ Qâ„“ [Xâˆ— (TF )]W
to be that induced by the norm TE â†’ TF . Since we are working in the split setting, this simply corresponds
âˆ¼
to multiplication by r on Xâˆ— (TE ) âˆ’
â†’ Zn .
Then b : HG(E),J â†’ HG(F ),J is determined by the commutativity of the following diagram ([Hai09], Â§3.2)
Z(HG(E),J )

b

Z(HG(F ),J )

âˆ¼ âˆ’âˆ—J IK

HG(E),K

âˆ¼ âˆ’âˆ—J IK
b

HG(F ),K
âˆ¼ S

âˆ¼ S

C[Xâˆ— (TE )]W

(7.2)

N

C[Xâˆ— (TF )]W (F )

For more on the base change homomorphism, see [Hai09] Â§3.
7.2. Geometrization of the Satake transform. In this section we will recall a geometric interpretation
of the Satake transform.
7.2.1. The classical Satake transform. We first review the Satake transform (cf. [Gro98]). Let HG,K be
the spherical Hecke algebra of G(F ) with respect to a hyperspecial maximal compact subgroup K. Let
HT = Qâ„“ [Xâˆ— (T )].
We choose a Borel subgroup B containing T and let N be its unipotent radical. There is a Satake
transform S : HG,K â†’ HT given by
Z
1/2
Sf (t) = Î´(t)
f (tx)dx,
N

where the Haar measure dx is normalized to assign volume 1 to N (Ot ).

Theorem 7.3 (Satake). The Satake transform gives a ring isomorphism
b âˆ¼
S : HG,K âˆ¼
= R(G)
= HTW

b is the representation ring of G
b with Qâ„“ -coefficients.
where R(G)
We have an isomorphism

HT âˆ¼
= Qâ„“ [Xâˆ— (T )].
Î»
For Î» âˆˆ Xâˆ— (T ), write t for the corresponding element of HT . Then we may write
Z
Sf (tÎ» ) = Î´(tÎ» )1/2
f (tÎ» x)dx.
N

(7.3)

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

27

7.2.2. Interpretation via semi-infinite orbits. We will interpret the function (7.3) geometrically, as the trace
function associated to a certain subscheme SÎ» , studied by Mirkovic-Vilonen in [MV07] Â§3, in the sense that
if fF is the trace function associated to F , then
SfF (tÎ» ) = q âˆ’Ï(Î») Tr(Frob, RÎ“c (SÎ» âŠ—k k, F ))
where Ï is the usual half sum of the positive roots.
Following the notation of [MV07], for Î» âˆˆ Xâˆ— (T ) we let LÎ» = tÎ» G(O) denote the image of Î» in the affine
Grassmannian GrG , and SÎ» be its orbit under NF .
Lemma 7.4. Let F be a sheaf on GrG defined over k, and fF its associated trace function (cf. (5.2)). Then
we have
SfF (tÎ» ) = q âˆ’Ï(Î») Tr(Frob, RÎ“c (SÎ» âŠ—k k, F )).
Proof. We study the rational points SÎ» (k), in preparation for an application of the Grothendieck-Lefschetz
trace formula. The stabilizer of tÎ» is
StabN (F ) (LÎ» ) = {n âˆˆ N (F ) : ntÎ» G(O) = tÎ» G(O)}
= {n âˆˆ N (F ) : tâˆ’Î» ntÎ» âˆˆ G(O)}.
This says that the map n 7â†’ tâˆ’Î» ntÎ» defines a bijection between StabN (F ) (LÎ» ) and N (O). Therefore the map
n 7â†’ tÎ» n defines a bijection between SÎ» = [N (F )/ StabN (F ) (LÎ» )] Â· LÎ» and N (F )/N (O). An application of
the Grothendieck-Lefschetz trace formula then yields
X
fF (n)
Tr(Frob, RÎ“c (SÎ» âŠ—k k, F )) =
nâˆˆSÎ» (k)

=

X

fF (tÎ» Â· n)

nâˆˆN (F )/N (O)

which is exactly what was claimed upon recalling that Î´(tÎ» ) = q Ï(Î») .



Theorem 7.5 (Mirkovic-Vilonen). There is a natural equivalence of functors
M
Hc2Ï(Î») (SÎ» , âˆ’) : PGO (GrG , Qâ„“ ) â†’ ModQâ„“ .
H âˆ— (âˆ’) âˆ¼
=
Î»âˆˆXâˆ— (T )

Proof. This is a result of Mirkovic-Vilonen for the affine Grassmannian over C ([MV07], Theorem 3.6). For
the generality we require, namely GrG over k = Fq , see [Zhu] Theorem 5.3.9 and the references indicated in
[Zhu] Remark 5.3.10.

Proposition 7.6. We have
Hcâˆ— (SÎ» , FÂµ âˆ— FÂµâ€² ) âˆ¼
=

M

Hcâˆ— (SÎ»1 , FÂµ ) âŠ— Hcâˆ— (SÎ»2 , FÂµâ€² )

Î»1 +Î»2 =Î»

Proof. This statement is proved implicitly in [MV07] Proposition 6.4. In fact, in view of Theorem 7.5 it is
equivalent to [MV07] Proposition 6.4.
Although the paper [MV07] works with the affine Grassmannian over C, this result is valid in general; it
is formulated in the general setting in [Zhu] Proposition 5.3.14, and a proof is sketched there.

Remark 7.7. We thank Timo Richarz for informing us that both Theorem 7.5 and Proposition 7.6 are now
formally written up in full generality in [HRa] Theorem 3.16 (proof of part ii).
7.3. Base change for spherical Hecke algebras. For r âˆˆ N, let kr be the (unique) extension of k of
degree r and Fr denote the unique unramified field extension of F of degree r. For each Âµ âˆˆ Xâˆ— (T ), we let
SatGrG ,r (Âµ) be the associated perverse sheaf on GrG,kr and we let Ïˆr,Âµ be the trace function on GrG (kr )
associated to SatGrG ,r (Âµ). We will give a geometric interpretation for b(Ïˆr,Âµ ).

28

TONY FENG

7.3.1. Weil restriction. It will be useful to adopt a different perspective on the Hecke algebra HG(Fr ),K . As
is usual, we can think of HG(Fr ),K as functions on GrG (kr ) â†’ Qâ„“ which are invariant with respect to the
left K-action. (We are abusing notation here by using K to denote both the maximal compact subgroups of
G(Fr ) and G(F ) corresponding to our chosen hyperspecial vertex.) However, using the identification
GrG (kr ) = (Reskr /k GrG,kr )(k)
we can instead consider HG(Fr ),K as functions on (Reskr /k GrG,kr )(k). Let Ï„ be the cyclic permutation on
GrrG,X given by
Ï„ (y1 , . . . , yr ) = (yr , y1 , . . . , yrâˆ’1 ).
By the definition of Weil restriction, we have a canonical bijection
âˆ¼

GrG (kr ) âˆ’
â†’ Fix(Frob â—¦Ï„, GrrG )
sending

y 7â†’ (y, Frob(y), . . . , Frobrâˆ’1 (y)).

Definition 7.8. For each Âµ âˆˆ Xâˆ— (T ), we let FÂµ := SatGrG (Âµ) be the perverse sheaf on GrG . Consider the
perverse sheaf
FÂµ(1) âŠ  . . . âŠ  FÂµ(r) âˆˆ Dcb (GrrG )
(1)
where FÂµ âˆ¼
= FÂµ ; the superscripts are just labellings. The endomorphism Ï„ on GrrG lifts to an endomorphism
(1)
(r)
Ï„e of FÂµ âŠ  . . . âŠ  FÂµ in an obvious way. Define a function
Î¶r,Âµ : Fix(Frob â—¦Ï„, GrrG ) â†’ Qâ„“

by

Î¶r,Âµ (y) := Tr(Frob â—¦e
Ï„ , (FÂµ(1) âŠ  . . . âŠ  FÂµ(r) )y ).
Proposition 7.9. The Î¶r,Âµ form a basis for HG(Fr ),K .
Proof. This is well-known. It amounts to the fact that the change-of-basis matrix between the standard
(double coset) basis of the Hecke algebra and the basis consisting of the Î¶r,Âµ is upper-triangular for the
Bruhat order.

7.3.2. Convolution product. Recall that there is a convolution product âˆ— on PervG(O) (GrG ) ([Zhu] Â§5).
Definition 7.10. Consider rth convolution product
FÂµâˆ—r := FÂµ(1) âˆ— . . . âˆ— FÂµ(r)
as a perverse sheaf on GrG . This has an automorphism Îºâ€² of order r given by the composition
Î¹

Îº

â†’ FÂµ(1) âˆ— . . . âˆ— FÂµ(r)
â†’ FÂµ(r) âˆ— FÂµ(1) âˆ— . . . âˆ— FÂµ(râˆ’1) âˆ’
FÂµ(1) âˆ— . . . âˆ— FÂµ(r) âˆ’
where Îº is the cyclic permutation obtained from the commutativity constraint F âˆ— B âˆ¼
= B âˆ— F of Geometric
(i+1 mod r)
(i mod r) âˆ¼
coming
Satake ([Zhu] Proposition 5.2.6), and Î¹ is the tautological isomorphism FÂµ
= FÂµ
(i)
from the fact that all the FÂµ are defined to be the same perverse sheaf.
(1)
(r)
Define Ï†r,Âµ : Fix(Frob â—¦Îºâ€² , FÂµ âˆ— . . . âˆ— FÂµ ) â†’ Qâ„“ by
Ï†r,Âµ (y) = Tr(Frob â—¦Îºâ€² , (FÂµ(1) âˆ— . . . âˆ— FÂµ(r) )y ).
7.3.3. The base change identity. We now explain the relationship between these functions and the base
change homomorphism.
Proposition 7.11. We have b(Î¶r,Âµ ) = Ï†r,Âµ .
Proof. By Theorem 7.3 it suffices to equate the Satake transforms of both sides. In other words, we must
prove the following identity:
Z
Z
Î»
b(Î¶r,Âµ )(t x) dx =
Ï†r,Âµ (tÎ» x) dx for all Î» âˆˆ Xâˆ— (T ).
N (F )

N (F )

By (7.2), this is equivalent to showing that
Z
Z
Î»
Î¶r,Âµ (t xr ) dxr =
N (Fr )

Ï†r,Âµ (trÎ» x) dx
N (F )

(7.4)

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

and that

Z

Ï†r,Âµ (tÎ» x) dx = 0

if r âˆ¤ Î» .

29

(7.5)

N (F )

To do this we use the Lefschetz trace formula4:
X
Tr(Frob â—¦e
Ï„ , Fy ) = Tr(Frob â—¦e
Ï„ , RÎ“c (Y âŠ—k k, F )).

(7.6)

yâˆˆFix(Frob â—¦Ï„,Y (k))

X

Tr(Frob â—¦Îºâ€² , Fy ) = Tr(Frob â—¦Îºâ€² , RÎ“c (Y âŠ—k k, F )).

(7.7)

yâˆˆFix(Frob â—¦Îºâ€² ,Y (k))
(1)

(r)

Applying (7.6) to Y := SÎ» Ã— . . . Ã— SÎ» and F := FÂµ âŠ  . . . âŠ  FÂµ and using Lemma 7.4 plus the KÃ¼nneth
theorem gives
Z
Î¶r,Âµ (tÎ» xr )dxr = q âˆ’Ï(Î») Tr(Frob â—¦e
Ï„ , RÎ“c (SÎ» âŠ—k k, FÂµ )âŠ—r ).
N (Fr )

We note that here Ï„e acts by cyclically permuting the tensor factors RÎ“c (SÎ» âŠ—k k, FÂµ )âŠ—r , and Frob acts
factorwise.
(r)
(1)
Applying (7.7) to Y = SÎ» and F = FÂµâˆ—r = FÂµ âˆ— . . . âˆ— FÂµ and using Lemma 7.4 gives
Z
Ï†r,Âµ (tÎ» x)dx = q âˆ’Ï(Î») Tr(Frob â—¦Îºâ€² , RÎ“c (SÎ» âŠ—k k, FÂµâˆ—r )).
(7.8)
N (F )

We first digest the expression (7.8). By Proposition 7.6 we have
RÎ“c (SÎ» âŠ—k k, FÂµ(1) âˆ— . . . âˆ— FÂµ(r) ) âˆ¼
=

M

r
O

RÎ“c (SÎ»i âŠ—k k, FÂµ ).

Î»1 +...+Î»r =Î» i=1

Letâ€™s try to understand the action of Îºâ€² , which is a composition Îºâ€² = Î¹ â—¦ Îº. The map Îº acts by cyclic
permutation of both the spaces and sheaves, so it induces the permutation
Îºâˆ— : Hcâˆ— (SÎ»1 âŠ—k k, FÂµ(1) ) âŠ— Hcâˆ— (SÎ»2 âŠ—k k, FÂµ(2) ) âŠ— . . . âŠ— RÎ“c (SÎ»r âŠ—k k, FÂµ(r) )
â†’ Hcâˆ— (SÎ»r âŠ—k k, FÂµ(r) ) âŠ— Hcâˆ— (SÎ»1 âŠ—k k, FÂµ(1) ) âŠ— . . . âŠ— RÎ“c (SÎ»râˆ’1 âŠ—k k, FÂµ(râˆ’1) ).
Next, the map Î¹ relabels the sheaves only, so the conclusion is that Îºâ€² induces
(Îºâ€² )âˆ— : Hcâˆ— (SÎ»1 âŠ—k k, FÂµ(1) ) âŠ— Hcâˆ— (SÎ»2 âŠ—k k, FÂµ(2) ) âŠ— . . . âŠ— RÎ“c (SÎ»r âŠ—k k, FÂµ(r) )
â†’ Hcâˆ— (SÎ»r âŠ—k k, FÂµ(1) ) âŠ— Hcâˆ— (SÎ»1 âŠ—k k, F (2) ) âŠ— . . . âŠ— RÎ“c (SÎ»râˆ’1 âŠ—k k, FÂµ(r) ).
In particular, we emphasize that the composition, at the level of cohomology, effects a permutation of the
spaces. Now, Frobenius preserves each tensor and summand. Therefore, Frob â—¦Îºâ€² acts on the summands of
the form
râˆ’1 O
r
M
Hcâˆ— (SÎ»i+j (mod r) âŠ—k k, FÂµ )
j=0 i=1

by a cyclic permutation followed by a factorwise endomorphism. From this form we see that if Î»1 , . . . , Î»r
are not all equal then Frob â—¦Îºâ€² permutes the summands freely, so Frob â—¦Îºâ€² has trace 0. In particular, if Î» is
not divisible by r then the Î»i cannot be all equal, so that the trace is 0. This establishes (7.5).
On the other hand, our analysis above implies that if Î» = rÎ»â€² then the contribution to Tr(Frob â—¦Îºâ€² ) all
comes from the terms with all Î»1 = . . . = Î»r = Î»â€² , and we have
Frob â—¦Îºâ€² |H âˆ— (SÎ»â€² âŠ—k k,FÂµ )âŠ—r = Frob â—¦e
Ï„ |H âˆ— (SÎ»â€² âŠ—k k,FÂµ )âŠ—r
c

so that

Z

N (Fr,t )

which establishes (7.4).

c

â€²

Ïˆr,Âµ (tÎ» xr )dxr =

Z

Ï†r,Âµ (tÎ» x) dx
N (Ft )



Lemma 7.12. We have Î¶r,Âµ = Ïˆr,Âµ .
4Note that this is applicable because Frob â—¦Ï„ is the Frobenius for a twisted form of Y : see the discussion beginning in the
last sentence of [Ngo99] p. 651.

30

TONY FENG

Proof. By Theorem 7.3 it suffices to check equality of the Satake transforms of both sides. Using Lemma
7.4, this amounts to showing
Tr(Frobr , RÎ“c (SÎ» âŠ—k k, FÂµ )) = Tr(Frob â—¦e
Ï„ , RÎ“c (SÎ» âŠ—k k, FÂµ )âŠ—r ).
This follows from the general linear algebra fact asserted in Lemma 7.13 below.



Lemma 7.13 (Saito-Shintani5). Let V be a finite-dimensional representation over a field k. Let Ï„ be the
endomorphism of V âŠ—r defined by
v1 âŠ— . . . âŠ— vr 7â†’ vr âŠ— v1 âŠ— . . . âŠ— vrâˆ’1 .
Then for all T1 , . . . , Tr âˆˆ End(V ), we have
Tr(T1 . . . Tr , V ) = Tr((T1 âŠ— . . . âŠ— Tr )Ï„, V âŠ—r ).
Proof. If {ei } is a basis for V , then
(T1 âŠ— . . . âŠ— Tr )Ï„ (ei1 âŠ— . . . âŠ— eir ) = T1 (eir ) âŠ— . . . âŠ— Tr (eirâˆ’1 ).
We expand out both sides of the desired equality:
X
hei1 âŠ— . . . âŠ— eir , T1 (eir ) âŠ— . . . âŠ— Tr (eirâˆ’1 )i
Tr((T1 âŠ— . . . âŠ— Tr )Ï„ ) =
i1 ,...,ir

=

X

hei1 , T1 (eir )i . . . heir , Tr (eirâˆ’1 )i

i1 ...,ir

and

Tr(T1 . . . Tr ) =

X

hei , T1 Â· Â· Â· Tr ei i.

i

Thus want to show that

X

hei1 , T1 (eir )i . . . heir , Tr (eirâˆ’1 )i =

X

hei , T1 Â· Â· Â· Tr ei i.

i

i1 ,...,ir

This follows by repeated iteration of the following more general identity.



Lemma 7.14. Let V be a finite-dimensional vector space with basis {ei }. For any T âˆˆ End(V ), we have
X
hx, T ej ihej , yi = hx, T yi.
(7.9)
j

Proof. It suffices to establish the equation for y ranging over a basis of V ; taking y = ei the left hand side
is hx, T ei i, and so is the right hand side.

Combining these results, we obtain the main formula of interest:
Theorem 7.15. We have b(Ïˆr,Âµ ) = Ï†r,Âµ .
Proof. This follows immediately upon combining Proposition 7.11 and Lemma 7.12.



7.4. Base change for the centers of parahoric Hecke algebras. We now establish an identity for
central functions of parahoric Hecke algebras analogous to Theorem 7.15. Not surprisingly, this will involve
globalizing to a degeneration from the spherical case.
7.4.1. Setup. We first set some notation. Pick a smooth global curve X/Fq (not necessarily projective) with
a rational point x0 âˆˆ X(Fq ). Let G â†’ X be a parahoric group scheme, such that G|Xâˆ’x0 âˆ¼
= G Ã— X and
G(Ox0 ) = J is a parahoric subgroup. We form the affine Grassmannian
Ï€ : GrG â†’ X.
Note that for x âˆˆ X âˆ’ x0 we have

GrG |x âˆ¼
= GrG Ã—k k(x).
For each Âµ âˆˆ Xâˆ— (T ), we let FÂµ := SatGrG (Âµ) be the (shifted) perverse sheaf on GrG and FÂµ,x0 be the reâ€²
âˆˆ HG(Fx0 âŠ—Fq Fqr ),J
striction to GrG,x0 . (We have normalized our shifts so that FÂµ,x0 is perverse.) We let Ïˆr,Âµ
be the function as in Definition 5.6.
5We ï¬rst found this explicitly stated, without proof, in [Ngo06], where it is said to be implicit in the work of Saito and
Shintani on base change.

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

31

7.4.2. Convolution product. By Theorem 5.12, RÎ¨(FÂµ ) := RÎ¨x0 (FÂµ ) is a central sheaf on GrG,x0 . We
therefore have, as in Definition 7.10, a map
Îºâ€² : RÎ¨(FÂµ )(1) âˆ— . . . âˆ— RÎ¨(FÂµ )(r)
Îº

âˆ’
â†’ RÎ¨(FÂµ )(r) âˆ— RÎ¨(FÂµ )(1) âˆ— . . . âˆ— RÎ¨(FÂµ )(râˆ’1)
Î¹

â†’ RÎ¨(FÂµ )(1) âˆ— . . . âˆ— RÎ¨(FÂµ )(r) .
âˆ’
Definition 7.16. Let
RÎ¨(FÂµ )âˆ—r := RÎ¨(FÂµ )(1) âˆ— . . . âˆ— RÎ¨(FÂµ )(r) .
{z
}
|
r times

Define

Ï†â€²Âµ :

â€²

âˆ—r

Fix(Frob â—¦Îº , RÎ¨(FÂµ ) ) â†’ Qâ„“ by

Ï†â€²Âµ (y) = Tr(Frob â—¦Îºâ€² , (RÎ¨(FÂµ )âˆ—r )y ).
â€²
Theorem 7.17. We have b(Ïˆr,Âµ
) = Ï†â€²Âµ .

Proof. By Theorem 5.12, Ï†â€²r,Âµ (y) is in the center of the Iwahori-Hecke algebra. (Since RÎ¨(FÂµ ) is central by
Theorem 5.12, Ï†â€²r,Âµ (y) clearly commutes with all the other functions of the form Ï†â€²r,Î½ (y); then use that such
things form a basis for the Iwahori Hecke algebra as Î½ runs over the extended affine Weyl group.)
Now the argument is essentially the same as for Corollary 5.14. Consider the map
â‰¤Âµ
pr : Grâ‰¤Âµ
G â†’ GrGÃ—X

induced by forgetting the level structure at x0 . Since pr is proper, by Lemma 5.9 and the fact that pr is an
isomorphism away from x0 we have
GrGÃ—X
G
(SatGrGÃ—X (Âµ)).
pr! RÎ¨Gr
x0 (FÂµ ) = RÎ¨x0

By Lemma 5.11 and the fact that GrGÃ—X â†’ X is smooth, we have
GÃ—X
(SatGrGÃ—X (Âµ)) âˆ¼
RÎ¨Gr
= SatGrGÃ—X (Âµ).
x0

Since pr! corresponds to âˆ’ âˆ—J IK at the level functions, this implies
Ï†â€²Âµ âˆ—J IK = Ï†Âµ .
Thus by Theorem 7.15 and (7.1), we have that
â€²
Ï†â€²Âµ âˆ—J IK = Ï†Âµ = b(Ïˆr,Âµ ) = b(Ïˆr,Âµ
) âˆ—J IK .

(7.10)

â€²
In view of the Bernstein isomorphism (Theorem 5.5), the fact that Ï†â€²Âµ and b(Ïˆr,Âµ
) are central plus (7.10)
implies that they are equal.


7.4.3. A global reformulation. We now recast Theorem 7.17 into a form that will be more suitable for our
eventual needs.
Let G and GrG be as in Â§7.4.1. We first recall a construction of the convolution product FÂµ âˆ— FÂµâ€² .
Recall the iterated global affine Grassmannian GrG,X 2 from Â§4.4.1. We can form the twisted tensor product
â€²
e Âµâ€² := SatGr 2 (Âµ, Âµâ€² ) on GrG,X 2 ([Zhu] Â§A), which is supported on the Schubert variety Grâ‰¤(Âµ,Âµ ) .
FÂµ âŠ F
G,X

G,X

Restricting to the diagonal X âŠ‚ X 2 , we have the multiplication map
â‰¤(Âµ,Âµâ€² )

m : GrG,X 2

â€²

|âˆ† â†’ GrGâ‰¤Âµ+Âµ

defined on points by
Ï•

Î²

Î²â—¦Ï•

(x, x, E1 99K E2 99K E 0 ) 7â†’ (x, E1 99K E 0 ).
Then the convolution product is defined by (cf. [MV07] Â§4 or [Zhu] Â§5.1)
â€²

e Âµâ€² ) âˆˆ PervL+ G (Grâ‰¤Âµ+Âµ ).
FÂµ âˆ— FÂµâ€² := Rm! (FÂµ âŠ F
G

(7.11)

32

TONY FENG

Let us now write down our particular situation of interest. Consider the diagram
â‰¤(Âµ ,...,Âµr )

GrG,X1r

|âˆ†

âˆ†(X) âŠ‚ X r

m
â‰¤Âµ1 +...+Âµr
GrG,X

X

Then by (7.11) we have
F (Âµ1 ) âˆ— . . . âˆ— F (Âµr ) = Rm! (SatGrG ,X r (Âµ1 , . . . , Âµr ))
Now Theorem 7.17 can be reformulated as follows, using Corollary 5.9 to commute Rm! and nearby cycles.
Proposition 7.18. Let r.Âµ := (Âµ, . . . , Âµ) âˆˆ Xâˆ— (T )r+ . Let fÎ½,x0 âˆˆ HG(Fx0 ),J be the function fÎ½ viewed in the
â€²
âˆˆ Z(HG(Fx0 ),J ) similarly. Then we have
parahoric Hecke algebra of Fx0 , and define ÏˆrÂµ,x
0
X
â€²
)=
b(Ïˆr,rÂµ,x
Tr(Ïƒ â—¦ Îºâ€² , RÎ¨X
x0 (Rm! SatGrâ‰¤r.Âµ ,X r (r.Âµ))Î½ )fÎ½,x0 .
0
G

Î½â‰¤rÂµ

8. Comparison of two moduli problems
8.1. Setup. We now let G be the group scheme of units of a global algebra D as in Â§4.5 and G a parahoric
group scheme corresponding to some choice of level structure at x0 , so ShtG are the D-shtukas studied in
Â§4.5.
Let Z âŠ‚ X be the set of places of ramification for D. We assume throughout that #Z â‰¥ n2 (||Âµ1 || + . . . +
||Âµr ||), so as to be able to apply Proposition 4.20.
Let X â—¦ := (X âˆ’ Z âˆ’ {x0 }). We will now define and compare two different moduli stacks of shtukas.
8.2. Situation A. Let
Z r
ShtÂµA := (Shtâ‰¤Âµ
G,X /a ) .

We have a map
Ï€A : ShtÂµA |(Xâˆ’Z)r â†’ (X âˆ’ Z)r .
â—¦
By Proposition 4.20 the restriction Ï€A
:= Ï€A |(X â—¦ )r is proper.

Definition 8.1. Let r.Âµ = (Âµ, . . . , Âµ). We define the following â€œsheafâ€ AÂµr âˆˆ Dcb ((X â—¦ )r ):
| {z }
r times

â—¦
AÂµr := RÏ€Aâˆ—
(SatShtÂµA (r.Âµ)).

We have the following easy but crucial property.
â—¦
Proposition 8.2. The complex AÂµr âˆˆ is locally constant on (X â—¦ )r , in the sense that each Ri Ï€Aâˆ—
(SatShtÂµA (r.Âµ))
is a local system.
â—¦
â—¦
Proof. By the properness of Ï€Aâˆ—
we know that Ri Ï€Aâˆ—
(SatShtÂµA (r.Âµ)) is constructible, and the local acyclicity
(Proposition 4.19) then implies that it is locally constant.


Note that by the KÃ¼nneth formula, we have
Âµ
AÂµr âˆ¼
= (A1 )âŠ r

Choose a basepoint x âˆˆ X â—¦ , and let xr âˆˆ (X â—¦ )r denote the diagonal point (x, . . . , x). Then the symmetric
group Sr acts on (X â—¦ )r , hence also Ï€1 ((X â—¦ )r , xr ). This lifts to an Sr -equivariant structure on the local
system AÂµr , i.e. an action of Ï€1 ((X â—¦ )r , xr ) â‹Š Sr on (AÂµr )xr , commuting with the action of the global Hecke
algebra HâŠ—r .

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

8.3. Situation B. Let

33

Z
ShtÂµB := Shtâ‰¤r.Âµ
G,X r /a

where r.Âµ = (Âµ, . . . , Âµ). We have a map
| {z }
r times

Ï€B : ShtÂµB |(Xâˆ’Z)r â†’ (X âˆ’ Z)r .

â—¦
By the assumption that D is totally ramified at sufficiently many places, the map Ï€B
:= Ï€B |(X â—¦ )r is proper
by Proposition 4.20.

Definition 8.3. We define the sheaf BrÂµ on (X â—¦ )r :
â—¦
BrÂµ := RÏ€Bâˆ—
(SatShtÂµB (r.Âµ)).

Proposition 8.4. The complex BrÂµ âˆˆ Dcb ((X â—¦ )r ) is locally constant on (X â—¦ )r , in the sense that each
â—¦
Ri Ï€Bâˆ—
(SatShtÂµB (r.Âµ)) is a local system.
Proof. The proof is the same as for Proposition 8.2.



Again, we have commuting actions of the Hecke algebra H and Ï€1 ((X ) , x ) â‹Š Sr on
â—¦ r

r

BrÂµ .

8.4. The comparison theorem.
Theorem 8.5 ([Ngo06]). Let Ï„ âˆˆ Sr be an r-cycle, i.e. hÏ„ i âˆ¼
= Z/rZ. For g âˆˆ Ï€1 ((X â—¦ )r , xr ) and h âˆˆ H we
have
Tr((h âŠ— 1 . . . âŠ— 1)gÏ„, (AÂµr )xr ) = Tr(hgÏ„, (BrÂµ )xr ).
Proof. This is [Ngo06] Â§3.3 Theorem 1. Since this is really crucial for us, we outline for the sake of exposition
how the proof goes. Keep in mind that AÂµr and BrÂµ are both local systems.
By an application of the Cebotarev density theorem, it suffices to prove the equality for g = Frob(x1 ,...,xr )
for a dense open subset of X r , and in particular on the locus (x1 , . . . , xr ) where the xi are pairwise distinct.
On this locus (and under a certain further restriction on the points (x1 , . . . , xr )) NgÃ´ independently computes
both sides of the equation, and verifies that they are equal by direct comparison.
Let us say a little more about this computation, which is carried out in [Ngo06] Â§5. Using the GrothendieckLefschetz trace formula to re-express both sides, there are two main inputs: (1) a count of fixed points, and
(2) a computation of the trace of Frobenius on the stalks of the relevant sheaves. The counting step is
done as in Â§6, and the analysis of the stalks enters via results as in Â§7.3. The interesting feature is that the
pairwise distinctness of the points (x1 , . . . , xr ), plus the extra restriction that we have omitted, turns out to
imply that the point counting formulas involve no twisted orbital integrals. Thus, no fundamental lemma is
required to prove the desired equality.

Remark 8.6. For a heuristic that underlies the theorem, coming from a conjectural description of the cohomology of shtukas, see [Ngo06] Â§2.2, 3.3. The punchline is that after admitting this conjectural description,
the identity in Theorem 8.5 reduces to Lemma 7.13.
Definition 8.7. Let
RÎ¨xr0 (AÂµr ) := RÏ€A! RÎ¨xr0 (SatShtÂµA (r.Âµ)|âˆ†(X â—¦ ) ) âˆˆ Dcb (x0 )
be the cohomology of nearby cycles at xr0 âˆˆ âˆ†(X âˆ’ Z), and let
RÎ¨xr0 (BrÂµ ) := RÏ€B! RÎ¨xr0 (SatShtÂµB (r.Âµ)|âˆ†(X â—¦ ) ) âˆˆ Dcb (x0 )
be the cohomology of nearby cycles at xr0 âˆˆ âˆ†(X âˆ’ Z).6 Again we apply Remark 5.8 to equip RÎ¨xr0 (AÂµr )
and RÎ¨xr0 (BrÂµ ) with Fq -structures.
Thanks to Proposition 8.2 and Proposition 8.4, the complex RÎ¨xr0 (AÂµr ) is equipped with commuting actions of Ï€1 ((X â—¦ )r , xr )â‹ŠSr and (H)âŠ—r , while RÎ¨xr0 (BrÂµ ) is equipped with commuting actions of Ï€1 ((X â—¦ )r , xr )â‹Š
Sr and H.
Corollary 8.8. For g âˆˆ Ï€1 ((X â—¦ )r , xr ) and h âˆˆ H we have
Tr((h âŠ— 1 . . . âŠ— 1) â—¦ Frob â—¦Ï„, RÎ¨xr0 (AÂµr )) = Tr(h â—¦ Frob â—¦Ï„, RÎ¨xr0 (BrÂµ )).
6This is a small abuse of the notation used in Â§5.2.

(8.1)

34

TONY FENG

Proof. This immediate from Theorem 8.5, Proposition 4.21 plus Corollary 5.10, and the Cebotarev density
theorem.

9. Calculation of traces on the cohomology of nearby cycles
Our next step is to combine the work of Â§5, Â§6 and Â§7 to prove Kottwitz-style formulas for both sides of
(8.1). We maintain the notation of those preceding sections.
9.1. Calculating the trace in situation A.
Definition 9.1. For a Kottwitz triple (Î³0 , (Î³x ), (Î´x )) write
c(Î³0 , (Î³x ), (Î´x )) := ker1 (F, GÎ³0 ) Â· vol(J Â· JÎ³0 (F )\JÎ³0 (AF )) Â· dg(K)âˆ’1
where the notation is as in Â§6.
Theorem 9.2. Let T â€² âŠ‚ |X â—¦ |. Assume that Kv := G(Ov ) is spherical at all v âˆˆ T â€² . Let
Î² = (Î²v âˆˆ Kv \G(Fv )/Kv )vâˆˆT â€²
and hÎ² âˆˆ H be the corresponding Hecke operator. Let RÎ¨xr0 (AÂµr ) be as in Definition 8.7, let Ï„ be as in
Theorem 8.5, let fÎ²v be as in Definition 5.1, and let Ïˆr,Âµâ€² be as in Â§7.4.1. Then we have
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (AÂµr ))
ï£«
ï£¶
X
Y
â€²
c(Î³0 , (Î³x ), (Î´x )) Â· ï£­
OÎ³v (fÎ²v )ï£¸ TOÎ´x0 Ïƒ (Ïˆr,Âµ
)
=
v6=x0

(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

Proof. Weâ€™ll use the Lefschetz trace formula to rewrite the trace in terms of a sum of traces over fixed points.
The effect of ÏƒÏ„ on a point of ShtA is illustrated below:
ï£±
ï£¼
ï£±
ï£¼
â‰¤Âµ
â‰¤Âµ Ïƒ
Ïƒ
Ïƒ2
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
âˆ’
âˆ’
â†’
E
|
E
|
âˆ’
âˆ’
â†’
E
|
E
|
1
Xâˆ’x
1
Xâˆ’x
r
Xâˆ’x
r
Xâˆ’x
0
0
0
0
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
2
â‰¤Âµ
â‰¤Âµ
ï£²Ïƒ E |
ï£½
ï£²
Ïƒ
Ïƒ
âˆ’â†’ E2 |Xâˆ’x0
E1 |Xâˆ’x0 âˆ’âˆ’â†’ E1 |Xâˆ’x0 ï£½
2 Xâˆ’x0 âˆ’
ÏƒÏ„
âˆ’âˆ’â†’
.
..
..
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
.
.
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
ï£´
â‰¤Âµ
â‰¤Âµ
ï£³Ïƒ
ï£¾
ï£³Ïƒ 2
ï£¾
Er |Xâˆ’x0 âˆ’âˆ’â†’ Er |Xâˆ’x0
Erâˆ’1 |Xâˆ’x0 âˆ’âˆ’â†’ Ïƒ Erâˆ’1 |Xâˆ’x0 .

Therefore, a fixed point of the correspondence (hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„ corresponds to a point as above
such that
E2 = Ïƒ E1
..
.
Er = Ïƒ Erâˆ’1
=Î²

E1 âˆ’âˆ’â†’ Ïƒ Er .
Hence a fixed point is equivalent to the data of commuting modifications
â‰¤Âµ

t : Ïƒ E1 |Xâˆ’x0 âˆ’âˆ’â†’ E1 |Xâˆ’x0
tâ€² :

Ïƒr

=Î²

E1 |Xâˆ’T â€² âˆ’âˆ’â†’ E1 |Xâˆ’T â€² .

Hence in the notation of Â§6 we see that
Fix((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„ ) =

[

C(Î½x0 , Î²; x0 , T â€² ; r).

Î½â‰¤Âµ

By Lemma 5.9 plus Proposition 4.21, we have
RÎ¨xr0 (AÂµr ) âˆ¼
= RÏ€A! (RÎ¨xr0 (SatShtA (r.Âµ))).

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

35

Now invoking the Grothendieck-Lefschetz trace formula, we have
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (AÂµr ))
X
X
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frob â—¦Ï„, RÎ¨xr0 (SatShtA (r.Âµ))Î ).
=
Î½â‰¤Âµ ÎâˆˆC(Î½x0 ,Î²;x0 ,T â€² ;r)

By Corollary 5.22, for all Î âˆˆ C(Î½x0 , Î²; x0 , T â€² ; r) we have
RÎ¨xr0 (SatShtA (r.Âµ))Î = RÎ¨xr0 (SatGrrG (r.Âµ))Î½ .
Now using Corollary 6.14, we can rewrite our formula as
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (AÂµr ))
Y
X
OÎ³v (fÎ²v )
c(Î³0 , (Î³x ), (Î´x )) Â·
=
v6=x0

(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

Â·

X

TOÎ´x0 Ïƒ (fÎ½ ) Â· Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frob â—¦Ï„, RÎ¨xr0 (SatGrrG (r.Âµ))Î½ ).

(9.1)

Î½â‰¤Âµ

Since the Hecke operator hÎ² supports a modification at T â€² , which is disjoint from x0 , it acts trivially on all
the stalks lying over xr0 , so we may ignore it when computing the trace in (9.1). Since
RÎ¨xr0 (SatGrrG (r.Âµ)) âˆ¼
= RÎ¨x0 (SatGrG (Âµ))âŠ r ,

(9.2)

the trace of Frob â—¦Ï„ coincides with the trace of Frobenius for the Satake sheaf on the Weil restriction
7
Reskr /k (Grâ‰¤Âµ
G âŠ—Fq Fqr ). Therefore, by [Ngo06] Â§5.2 Proposition 3, we have
Tr(Frob â—¦Ï„, RÎ¨xr0 (SatGrrG (r.Âµ))Î½ ) = Tr(Frobr , RÎ¨xr0 (SatGrG (Âµ))Î½ ).

(9.3)

Substituting (9.3) into (9.1) we arrive at
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (AÂµr ))
Y
X
OÎ³v (fÎ²v )
c(Î³0 , (Î³x ), (Î´x )) Â·
=
(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

Â·

X

v6=x0

TOÎ´x0 Ïƒ (fÎ½ ) Â· Tr(Frobr , RÎ¨xr0 (SatGrG (Âµ))Î½ ).

(9.4)

Î½â‰¤Âµ

By Lemma 5.17 we have the following identity:
X
â€²
Ïˆr,Âµ
=
Tr(Frobr , RÎ¨xr0 (SatGrG (Âµ))Î½ )fÎ½ .
Î½â‰¤Âµ

Substituting this in (9.4), we finally find
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (AÂµr ))
ï£«
ï£¶
X
Y
â€²
c(Î³0 , (Î³x ), (Î´x )) Â· ï£­
=
OÎ³v (fÎ²v )ï£¸ Â· TOÎ´x0 Ïƒ (Ïˆr,Âµ
)
(Î³0 ,(Î³x ),(Î´x0 ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

v6=x0

which is what we wanted to show.



7The proof of this formula, which is not explicitly written in [Ngo06], goes as follows. By (9.2) we have

Tr(Frob â—¦Ï„, RÎ¨xr0 (SatGrrG (r.Âµ))Î½ ) = Tr(Frob â—¦Ï„, RÎ¨x0 (SatGrG (Âµ))âŠ r
Î½ )
= Tr(Frobr , RÎ¨x0 (SatGrG (Âµ))Î½ ),
where in the last equality we used Lemma 7.13.

36

TONY FENG

9.2. Calculating the trace in situation B. We now want to prove an analogous formula for the trace in
situation B. The computation in this case is a little more involved. The main reason is that the action of Sr
on Bxr0 is difficult to understand explicitly. Recall that is was obtained from the fact that B|U was a local
system, so that we could extend it over X. However, this process obfuscates the geometric meaning of this
action, and we will need to use the results of Â§7, particularly the geometric model of base change studied in
Â§7.4.3, in order to understand it.
Theorem 9.3. Let T â€² âŠ‚ |X â—¦ |. Assume that Kv := G(Ov ) is spherical at all v âˆˆ T â€² . Let
Î² = (Î²v âˆˆ Kv \G(Fv )/Kv )vâˆˆT â€²
and hÎ² âˆˆ H be the corresponding Hecke operator. Let RÎ¨xr0 (BrÂµ ) be as in Definition 8.7, let Ï„ be as in
Theorem 8.5, and let Ïˆr,Âµâ€² be as in Â§7.4.1. Then we have
Tr(hÎ² â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (BrÂµ ))
=

X

(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

ï£«

c(Î³0 , (Î³x ), (Î´x )) Â· ï£­

Y

v6=x0

ï£¶

â€²
OÎ³v (fÎ²v )ï£¸ Â· OÎ³x0 (b(Ïˆr,Âµ
)).

Proof. Let X (r) = Symr (X) by the rth symmetric power of X, and
ShtÂµB,X (r) := Shtâ‰¤r.Âµ
/aZ .
G,X (r)
The idea here is to push down the computation from X r to X (r) , which trivializes the Sr action on the fiber
ShtB,X (r) over a point, transferring the effect of this action completely to the sheaf theory, where it was
studied in Â§7. Consider the following commutative diagram, in which the front cartesian square is the fiber
of the back cartesian square over the diagonal copy of X in X (r) .
ShtÂµB
m

ShtÂµB,X (r)

Xr
add

X (r)
(9.5)

â‰¤r.Âµ
|âˆ†
ShtB

âˆ†(X)

m

add

Z
Shtâ‰¤rÂµ
G,X /a

Ï€

âˆ†(X)

The map add : X r â†’ X (r) is totally ramified over the diagonal âˆ†(X) âŠ‚ X r , so for any Ã©tale sheaf F on X r
the stalk of F at xr âˆˆ X r is canonically identified with the stalk of addâˆ— F at add(xr ) âˆˆ X (r) . Therefore,
from the front cartesian square we have
Tr(hÎ² â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (BrÂµ )) = Tr(hÎ² â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (RÏ€!â—¦ Rm! SatShtÂµB (r.Âµ)))
where Ï€ â—¦ is the restriction of Ï€ to the fiber over (the diagonal embedding of) X â—¦ . We now proceeding as
before, using the Grothendieck-Lefschetz trace formula to rewrite the trace in terms of a sum of traces over
Z
fixed points. We begin by describing the fixed points of hÎ² â—¦ Frobx0 â—¦Ï„ on Shtâ‰¤rÂµ
G,X /a .
Âµ
Now, on ShtB,X (r) the permutation Ï„ evidently acts trivially. A point of ShtG,X /aZ |x0 is a modification
Ïƒ

â‰¤rÂµ

E1 |Xâˆ’x0 âˆ’âˆ’âˆ’â†’ E1 |Xâˆ’x0

occurring over x0 . The map Ïƒ takes this to
Ïƒ2

â‰¤rÂµ

E1 |Xâˆ’x0 âˆ’âˆ’âˆ’â†’ Ïƒ E1 |Xâˆ’x0 .

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

37

Therefore, a fixed point of the correspondence hÎ² â—¦ Frobx0 â—¦Ï„ is equivalent to the data of commuting modifications
â‰¤rÂµ

t : Ïƒ E1 |Xâˆ’x0 âˆ’âˆ’âˆ’â†’ E1 |Xâˆ’x0
=Î²

tâ€² : Ïƒ E1 |Xâˆ’T â€² âˆ’âˆ’â†’ E1 |Xâˆ’T â€² .
Hence we see that (remember that x0 is assumed to have degree 1)
[
Fix(hÎ² â—¦ Frobx0 â—¦Ï„ ) =
C(Î½x0 , Î²; x0 , T â€² ; 1)
Î½â‰¤rÂµ

so by the Grothendieck-Lefschetz trace and arguing as in Â§9.1 for situation A,
X
Tr(hÎ² â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (BrÂµ )) =
#C(Î½x0 , Î²; x0 , T â€² ; 1)
Î½â‰¤rÂµ

Â· Tr(hÎ² â—¦ Frob â—¦Ï„, RÎ¨xr0 (Rm! SatShtÂµB (r.Âµ))Î½ ).

Using Theorem 6.14, we rewrite this as
Tr(hÎ² â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (BrÂµ ))
Y
X
c(Î³0 , (Î³x ), (Î´x )) Â·
OÎ³v (fÎ²v )
=
v6=x0

(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

Â·

X

TOÎ´x0 (fÎ½ ) Â· Tr(hÎ² â—¦ Frob â—¦Ï„, RÎ¨xr0 (Rm! SatShtÂµB (r.Âµ))Î½ ).

(9.6)

Î½â‰¤Âµ

As in the previous calculation for situation A, the Hecke operator acts trivially on the stalk at x0 because
is supported on a disjoint set of points. We use the affine Grassmannian as a local model to calculate
Tr(Frobx0 â—¦Ï„, RÎ¨xr0 (Rm! SatShtB (r.Âµ))Î½ ). By Theorem 5.19, we have
Tr(Frobx0 â—¦Ï„, RÎ¨xr0 (Rm! SatShtÂµB (r.Âµ))Î½ ) = Tr(Frobx0 â—¦Îºâ€² , RÎ¨xr0 (Rm! SatGrâ‰¤r.Âµr (r.Âµ))Î½ ),

(9.7)

G,X

where the notation on the right hand side is as in Corollary 7.18, if we can show that the permutation Ï„ on
the left side is carried by Theorem 5.19 to the permutation Îºâ€² studied in Â§7.4.3. (The same issue is raised
and explained in [Ngo06] Â§5.6 Proposition 3.) To prove it, consider the diagram
f â‰¤r.Âµ
W
Xr
m

f â‰¤rÂµ
W
X (r)

Grâ‰¤r.Âµ
G,X r
m

Grâ‰¤rÂµ
G,X (r)

Ã©tale

ShtÂµB
Ã©tale

m

ShtÂµB,X (r)

Xr
add

X (r)

â‰¤r.Âµ
f â‰¤r.Âµ
f â‰¤rÂµ
Here W
expresses Grâ‰¤r.Âµ
|âˆ† and W
expresses Grâ‰¤rÂµ
as a local model
Xr
G,X r as a local model for ShtB
X (r)
G,X (r)
Âµ
for ShtB,X (r) . The existence of such a commutive diagram is immediate from the proof of Theorem 5.19.
The claim is then that the permutation actions on RÎ¨xr0 (Rm! SatGrG,X r (r.Âµ)) and RÎ¨xr0 (Rm! SatShtB (r.Âµ)),
induced by middle extension from (X â—¦ )r to (X âˆ’ Z)r , are compatible. This is clear from the diagram and
the fact that the identity can be checked on the locus where the points (x1 , . . . , xr ) are distinct, where it is
evidently given by the same geometric permutation action in both cases.
Now combining Proposition 7.18, Corollary 5.22, and Lemma 5.17, we have
X
â€²
b(Ïˆr,Âµ
)=
Tr(Frob â—¦Îºâ€² , RÎ¨xr0 (Rm! SatGrG (Âµ))Î½ )fÎ½ .
(9.8)
Î½â‰¤rÂµ

38

TONY FENG

Putting together (9.6), (9.7), and (9.8) gives
Tr((hÎ² âŠ— 1 . . . âŠ— 1) â—¦ Frobx0 â—¦Ï„, RÎ¨xr0 (BrÂµ ))
X

=

(Î³0 ,(Î³x ),(Î´x0 ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

ï£«

c(Î³0 , (Î³x ), (Î´x )) Â· ï£­

Y

v6=x0

ï£¶

â€²
OÎ³v (fÎ²v )ï£¸ TOÎ´x0 (b(Ïˆr,Âµ
))

which is what we wanted to show.



9.3. The base change fundamental lemma for parahoric Hecke algebras. We can now deduce some
cases of the base change fundamental lemma.
Corollary 9.4. Let T â€² âŠ‚ |X â—¦ |. Assume that Kv := G(Ov ) is spherical at all v âˆˆ T â€² . Let
Î² = (Î²v âˆˆ Kv \G(Fv )/Kv )vâˆˆT â€²
and hÎ² âˆˆ H be the corresponding Hecke operator. Let Ïˆr,Âµâ€² be as in Â§7.4.1 and the base change homomorphim
Ïˆr,Âµâ€² 7â†’ b(Ïˆr,Âµâ€² ) be as in Â§7.1. Then we have
ï£«
ï£¶
Y
X
â€²
c(Î³0 , (Î³x ), (Î´x )) Â· ï£­
OÎ³0 (fÎ²v )ï£¸ Â· TOÎ´x0 Ïƒ (Ïˆr,Âµ
)
v6=x0

(Î³0 ,(Î³x ),(Î´x ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

=

X

(Î³0 ,(Î³x ),(Î´x0 ))
inv(Î³0 ,(Î³x ),(Î´x ))=0

ï£«

c(Î³0 , (Î³x ), (Î´x )) Â· ï£­

Y

v6=x0

ï£¶

â€²
OÎ³0 (fÎ²v )ï£¸ Â· OÎ³0 (b(Ïˆr,Âµ
))

Proof. This follows immediately from substituting Theorem 9.2 and Theorem 9.3 into Corollary 8.8, and the
following comment about changing the Î³v to Î³0 : since by definition of X âˆ’ Z we have that G(Fx ) âˆ¼
= GLn (Fx )
for all x âˆˆ X âˆ’ Z, the notion of stable conjugacy coincides with the notion of conjugacy.

It seems to be â€œwell-knownâ€ how to deduce a fundamental lemma from a statement such as Corollary 9.4.8
Nevertheless, let us give a proof for completeness, following [Ngo06] Â§5.7 ThÃ©orÃ¨me 1. First we introduce a
piece of notation.
Definition 9.5. For Âµ = (Âµ1 , . . . , Âµn ) âˆˆ Xâˆ— (GLn ) âˆ¼
= Zn , we define
|Âµ| := Âµ1 + . . . + Âµn .
Shtâ‰¤Âµ
G

is non-empty if and only if |Âµ| = 0, because a G-bundle has the notion of degree on X,
The stack
which is preserved by the Frobenius twist Ïƒ on S. Let
Z(HG(Fx0 ,r ),J )0 âŠ‚ Z(HG(Fx0 ),J )
â€²
be the subspace generated by the Ïˆr,Âµ
with |Âµ| = 0, which is the same as the subspace generated by the Ïˆr,Âµ
with |Âµ| = 0.

Theorem 9.6. Let Fx0 be a local field of characteristic p, and Fx0 ,r /Fx0 the unramified extension of degree
r. Let Î´ be a Ïƒ-conjugacy class in GLn (Fx0 ,r ), with norm N Î´x0 = Î³x0 âˆˆ GLn (Fx0 ). Assume Î³x0 is regular
semisimple and separable. If Ï† âˆˆ Z(HG(Fx0 ,r ),J )0 , then we have
TOÎ´x0 Ïƒ (Ï†) = OÎ³x0 (b(Ï†)).
Proof. Choose a global curve X with function field F , and write Fx0 âˆ¼
= Fq ((t)). Choose a division algebra
D as in Â§8.1, and define G and G as in Â§4.5. We can then apply Corollary 9.4.
For a fixed function h âˆˆ HG,K (A) the orbital integrals and twisted orbital integrals are locally constant
near regular semisimple separable elements. Therefore, by weak approximation we can choose e
Î³ âˆˆ G(F )
8It is remarked on p.84 of the Arxiv version 2 of [Ngo06] that this is â€œstandardâ€, and a reference is given to [Clo90].

NEARBY CYCLES OF PARAHORIC SHTUKAS, AND A FUNDAMENTAL LEMMA FOR BASE CHANGE

39

close enough to Î³t in the t-adic topology so that Î³
e = N (Î´ex0 ) âˆˆ G(Ft âŠ—Fq Fqr ) for some Î´ex0 âˆˆ G(Ft âŠ—Fq Fqr ),
and such that
OÎ³x0 (b(ÏˆÂµ )) = OeÎ³ (b(ÏˆÂµ ))

TOÎ´x0 Ïƒx0 (ÏˆÂµ ) = TOÎ´ex

0 Ïƒx0

(ÏˆÂµ ).

We can choose an appropriate Hecke operator h = (hv ) âˆˆ HG (A) so that OeÎ³ (hv ) 6= 0 for v 6= x.
Because a fixed choice of h is the identity at all but finitely many places, any Kottwitz triple for which
the product of orbital integrals is non-zero forces the Î³v to be in Kv at all but finitely many v. Then by
[Kot86b] Proposition 7.1 there are only finitely many possibilities for the Kottwitz triple, as all Î³v outside a
fixed finite set must be (rationally) conjugate to Î³. (Technically this discussion is unnecessary here because
we are only dealing with GLn at this point.) Therefore, since the support of any adelic Hecke operator is
compact open in G(A), while G(F ) is discrete, for any fixed h âˆˆ HG,K (A) there are only finitely many
non-zero summands in Corollary 9.4.
Again by the discreteness of G(F ) in G(A), we may shrink the support of the chosen Hecke operator
appropriately so that all the terms
ï£«
ï£¶
ï£«
ï£¶
Y
Y
â€²
â€²
ï£­
OÎ³0 (hv )ï£¸ Â· TOÎ´x0 Ïƒ (Ïˆr,Âµ
) and ï£­
OÎ³0 (hv )ï£¸ Â· OÎ³0 (b(Ïˆr,Âµ
))
v6=x0

v6=x0

vanish except for the chosen Î³x0 . Then we have
ï£«
ï£¶
Y
â€²
c(Î³0 , (Î³x ), (Î´x )) Â· ï£­
OÎ³0 (hv )ï£¸ Â· TOÎ´x0 Ïƒ (Ïˆr,Âµ
)
v6=x0

ï£«

= c(Î³0 , (Î³x ), (Î´x )) Â· ï£­

Y

v6=x0

ï£¶

â€²
OÎ³0 (hv )ï£¸ Â· OÎ³0 (b(Ïˆr,Âµ
))

is non-empty
Since |Âµ| = 0, Shtâ‰¤Âµ
G
 are not 0. Dividing out by the common (necessarily
Q so these terms
â€²
non-zero) factor c(Î³0 , (Î³x ), (Î´x )) Â·
v6=x0 OÎ³0 (hv ) then yields the desired equality for all Ïˆr,Âµ with |Âµ| = 0.
We conclude by observing that these span Z(HG(Fx0 ,r ),J )0 .

References
[Bro13]
[Clo90]
[Del73]

Michael Broshi, G-torsors over a Dedekind scheme, J. Pure Appl. Algebra 217 (2013), no. 1, 11â€“19. MR 2965898
Laurent Clozel, The fundamental lemma for stable base change, Duke Math. J. 61 (1990), no. 1, 255â€“302. MR 1068388
P. Deligne, SÃ©minaire de gÃ©omÃ©trie algÃ©brique du Bois Marie: Groupes de Monodromie en GÃ©ometrie AlgÃ©brique
(SGA 7 II)., Lecture Notes in Mathematics, vol. 569, Springer-Verlag, 1973.
[Dri87] V. G. Drinfelâ€™d, Cohomology of compactified moduli varieties of F -sheaves of rank 2, Zap. Nauchn. Sem. Leningrad.
Otdel. Mat. Inst. Steklov. (LOMI) 162 (1987), no. Avtomorfn. Funkts. i Teor. Chisel. III, 107â€“158, 189. MR 918745
[Gai01] D. Gaitsgory, Construction of central elements in the affine Hecke algebra via nearby cycles, Invent. Math. 144
(2001), no. 2, 253â€“280. MR 1826370
[Gro98] Benedict H. Gross, On the Satake isomorphism, Galois representations in arithmetic algebraic geometry (Durham,
1996), London Math. Soc. Lecture Note Ser., vol. 254, Cambridge Univ. Press, Cambridge, 1998, pp. 223â€“237.
MR 1696481
[Hai09] Thomas J. Haines, The base change fundamental lemma for central elements in parahoric Hecke algebras, Duke Math.
J. 149 (2009), no. 3, 569â€“643. MR 2553880
[HRa]
Thomas Haines and Timo Richarz, The test function conjecture for parahoric local models, Preprint available at
https://arxiv.org/pdf/1801.07094.pdf.
[HRb]
Urs Hartl and Esmail Arasteh Rad, Langlands-rapoport conjecture over function fields, Preprint available at
https://arxiv.org/pdf/1605.01575.pdf.
[Kot80] Robert Edward Kottwitz, Orbital integrals on GL3 , Amer. J. Math. 102 (1980), no. 2, 327â€“384. MR 564478
[Kot86a] Robert E. Kottwitz, Base change for unit elements of Hecke algebras, Compositio Math. 60 (1986), no. 2, 237â€“250.
MR 868140
, Stable trace formula: elliptic singular terms, Math. Ann. 275 (1986), no. 3, 365â€“399. MR 858284
[Kot86b]
, Shimura varieties and Î»-adic representations, Automorphic forms, Shimura varieties, and L-functions, Vol.
[Kot90]
I (Ann Arbor, MI, 1988), Perspect. Math., vol. 10, Academic Press, Boston, MA, 1990, pp. 161â€“209. MR 1044820
, Points on some Shimura varieties over finite fields, J. Amer. Math. Soc. 5 (1992), no. 2, 373â€“444. MR 1124982
[Kot92]

40

[KP]

TONY FENG

Mark Kisin and Georgios Pappas, Integral models of Shimura varieties with parahoric level structure, Preprint available at https://arxiv.org/pdf/1512.01149.pdf .
[KW01] Reinhardt Kiehl and Rainer Weissauer, Weil conjectures, perverse sheaves and lâ€™adic Fourier transform, Ergebnisse
der Mathematik und ihrer Grenzgebiete. 3. Folge. A Series of Modern Surveys in Mathematics [Results in Mathematics
and Related Areas. 3rd Series. A Series of Modern Surveys in Mathematics], vol. 42, Springer-Verlag, Berlin, 2001.
MR 1855066
[Lab90] J.-P. Labesse, Fonctions Ã©lÃ©mentaires et lemme fondamental pour le changement de base stable, Duke Math. J. 61
(1990), no. 2, 519â€“530. MR 1074306
[Laf97] Laurent Laï¬€orgue, Chtoucas de Drinfeld et conjecture de Ramanujan-Petersson, AstÃ©risque (1997), no. 243, ii+329.
MR 1600006
, Chtoucas de Drinfeld et correspondance de Langlands, Invent. Math. 147 (2002), no. 1, 1â€“241. MR 1875184
[Laf02]
[Laf12] Vincent Laï¬€orgue, Chtoucas pour les groupes rÃ©ductifs et paramÃ©trisation de Langlands globale, preprint,
https://arxiv.org/pdf/1209.5352.pdf (2012).
[Lau04] Eike SÃ¶ren Lau, On generalised D-shtukas, Bonner Mathematische Schriften [Bonn Mathematical Publications], vol.
369, UniversitÃ¤t Bonn, Mathematisches Institut, Bonn, 2004, Dissertation, Rheinische Friedrich-Wilhelms-UniversitÃ¤t
Bonn, Bonn, 2004. MR 2206061
[MV07] I. MirkoviÄ‡ and K. Vilonen, Geometric Langlands duality and representations of algebraic groups over commutative
rings, Ann. of Math. (2) 166 (2007), no. 1, 95â€“143. MR 2342692
[ND13] Tuan Ngo Dac, Comptage des G-chtoucas: la partie elliptique, Compos. Math. 149 (2013), no. 12, 2169â€“2183.
MR 3143709
[ND15]
, On a counting problem for G-shtukas, Arithmetic and geometry, London Math. Soc. Lecture Note Ser., vol.
420, Cambridge Univ. Press, Cambridge, 2015, pp. 318â€“350. MR 3467129
[Ngo99] Bao ChÃ¢u Ngo, Faisceaux pervers, homomorphisme de changement de base et lemme fondamental de Jacquet et Ye,
Ann. Sci. Ã‰cole Norm. Sup. (4) 32 (1999), no. 5, 619â€“679. MR 1710755
, D-chtoucas de Drinfeld Ã  modifications symÃ©triques et identitÃ© de changement de base, Ann. Sci. Ã‰cole Norm.
[Ngo06]
Sup. (4) 39 (2006), no. 2, 197â€“243. MR 2245532
[NND08] Bao ChÃ¢u NgÃ´ and TuÃ¢n NgÃ´ Dac, Comptage de G-chtoucas: la partie rÃ©guliÃ¨re elliptique, J. Inst. Math. Jussieu 7
(2008), no. 1, 181â€“203. MR 2398149
[PR10] Georgios Pappas and Michael Rapoport, Some questions about G-bundles on curves, Algebraic and arithmetic structures of moduli spaces (Sapporo 2007), Adv. Stud. Pure Math., vol. 58, Math. Soc. Japan, Tokyo, 2010, pp. 159â€“171.
MR 2676160
[PZ13]
G. Pappas and X. Zhu, Local models of Shimura varieties and a conjecture of Kottwitz, Invent. Math. 194 (2013),
no. 1, 147â€“254. MR 3103258
[RD]
Walter Randolph Ray-Dulany, Base change for the iwahori-hecke algebra of gl2 , Ph.D. thesis. Available at
https://drum.lib.umd.edu/bitstream/handle/1903/10963/RayDulany_umd_0117E_11632.pdf?sequence=1&isAllowed=y .
[Ric16] Timo Richarz, Affine Grassmannians and geometric Satake equivalences, Int. Math. Res. Not. IMRN (2016), no. 12,
3717â€“3767. MR 3544618
[Var04] Yakov Varshavsky, Moduli spaces of principal F -bundles, Selecta Math. (N.S.) 10 (2004), no. 1, 131â€“166. MR 2061225
[Zhu]
Xinwen Zhu, An introduction to affine Grassmannians and the geometric Satake equivalence, To appear in Proceedings
of the IAS/Park City Mathematics Series. Preprint available at https://arxiv.org/pdf/1603.05593.pdf .
, On the coherence conjecture of Pappas and Rapoport, Ann. of Math. (2) 180 (2014), no. 1, 1â€“85. MR 3194811
[Zhu14]

