% vtexbptsetup.sty
% interfeisas bptools irankiui
%
% Programming: Vytas Statulevicius, VTEX, Lithuania, 2010
% e-mail: vytas@vtex.lt
%
% 2010.08.11 - start
% 2010.11.12 - pridetas raktas sort-refs
%            - \setbpt@key gali tureti pap.opcija
% 2011.07.19 - prideti raktai:only-mr,struct, project
% 2011.09.06 - ivestas raktas citation-type
% 2012.01.20 - ivestas raktas cfg ir interfeisine komanda \definebptkey{<key>}[true|false]
% 2012.03.15 - kraunamas keyval paketas
% 2012.09.27 - OTRS#15150: auxspecial (ES)
% 2014.11.27 - OTRS#112739: search-all, search-mr, search-zbl (ES)
% 2017.10.11 - OTRS#122113: update-cache (ES)

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{vtexbptsetup}[2017/10/11
                                  bptool setup interface (VS)]

\newif\if@specialtoaux \@specialtoauxfalse
\DeclareOption{specialtoaux}{\global\@specialtoauxtrue}

\ProcessOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% vartotojo interfeisas: bptsetup
%
% \bptsetup{tool=imsref, debug, sources=mr, citation-type=nameyear,bibstyle=imsart}
%
% opcijos      default
% debug        false
% keep-files   false
% source       {mr pbm}
% 
% version      local
% tool         imsref
% sort-refs    sort|unsort|default
% only-mr      false
% struct       false
%
% tool nustato iranki, poto nusistato parametrai:
% vtex:settings.imsref={+debug}
% vtex:settings.imsref={sources="mr"}
% vtex:settings.imsref={citation-type=nameyear}
% vtex:settings.imsref={bibstyle=ims-number}
% vtex:settings.imsref={sort-refs=sort}
% vtex:settings.runtool={tool=sometool}
% vtex:settings.runtool={version=1.1}
% vtex:settings.sometool={cfg=configuration}
%
% interfeisas paciam ivedineti raktus:
% paprastas raktas:
%   \definebptkey{<key>}
%
% loginis raktas:
%   \definebptkey{<key>}[true|false]

\@ifpackageloaded{keyval}{}{\RequirePackage{keyval}}
 
% raktai su reiksme true|false
\define@key{bptsetup}{debug}        [true]{\bpt@boolkey{\bpt@runtool}{debug}{#1}{+debug}{-debug}}
\define@key{bptsetup}{keep-files}   [true]{\bpt@boolkey{\bpt@runtool}{keep-files}{#1}{+keep-files}{-keep-files}}
\define@key{bptsetup}{ignore-errors}[true]{\bpt@boolkey{\bpt@runtool}{ignore-errors}{#1}{+ignore-errors}{-ignore-errors}}
\define@key{bptsetup}{only-mr}      [true]{\bpt@boolkey{\bpt@runtool}{only-mr}{#1}{+only-mr}{-only-mr}}
\define@key{bptsetup}{struct}       [true]{\bpt@boolkey{\bpt@runtool}{struct}{#1}{+struct}{-struct}}
\define@key{bptsetup}{search-all}   [true]{\bpt@boolkey{\bpt@runtool}{search-all}{#1}{+search-all}{-search-all}}
\define@key{bptsetup}{search-zbl}   [true]{\bpt@boolkey{\bpt@runtool}{search-zbl}{#1}{+search-zbl}{-search-zbl}}
\define@key{bptsetup}{search-mr}    [true]{\bpt@boolkey{\bpt@runtool}{search-mr}{#1}{+search-mr}{-search-mr}}
\define@key{bptsetup}{update-cache} [true]{\bpt@boolkey{\bpt@runtool}{update-cache}{#1}{+update-cache}{-update-cache}}

% raktai su parametru
\define@key{bptsetup}{sources}      {\setbpt@key{\bpt@runtool}{sources="#1"}}
\define@key{bptsetup}{timeout}      {\setbpt@key{\bpt@runtool}{timeout=#1}}
\define@key{bptsetup}{bibstyle}     {\setbpt@key{\bpt@runtool}{bibstyle=#1}}
\define@key{bptsetup}{project}      {\setbpt@key{\bpt@runtool}{project=#1}}
\define@key{bptsetup}{citation-type}{\setbpt@key{\bpt@runtool}{citation-type=#1}}
\define@key{bptsetup}{cfg}          {\setbpt@key{\bpt@runtool}{cfg=#1}}


% raktai su fiksuotu parametru
\define@key{bptsetup}{sort-refs}{\setbpt@key[sort,unsort,default]{\bpt@runtool}{sort-refs=#1}}

\define@key{bptsetup}{tool}         {\setbpt@key{runtool}{tool=#1}\gdef\bpt@runtool{#1}}
\define@key{bptsetup}{version}      {\setbpt@key{runtool}{version=#1}}

%% interfeisas paciam ivedineti raktus:
%% paprastas raktas:
% \definebptkey{<key>}
%
%% loginis raktas
% \definebptkey{<key>}[true|false]

\def\definebptkey#1{\@ifnextchar[{\define@bpt@boolkey{#1}}{\define@bpt@key{#1}}}


\def\define@bpt@key#1{\define@key{bptsetup}{#1}{\setbpt@key{\bpt@runtool}{#1="##1"}}}

\def\define@bpt@boolkey#1[#2]{\define@key{bptsetup}{#1}[#2]{\bpt@boolkey{\bpt@runtool}{#1}{##1}{+#1}{-#1}}}

% \definebptboolkey{<key>}{true|false}{+switch}{-switch}

% \bpt@bolkey{tool}{key}{true|false}{<true>}{<false>}

\def\bool@true{true}
\def\bool@false{false}
\newif\if@boolkey

\def\bpt@boolkey#1#2#3#4#5{%
  \@ifundefined{bpt@runtool}{\@latex@error{bptsetup nenurodytas irankis (tool)!}{}}%
  \@boolkeyfalse%
  \def\@tempa{#3}%
  \ifx\@tempa\bool@true%
     \setbpt@key{#1}{#4}%
     \@boolkeytrue%
  \fi%
  \ifx\@tempa\bool@false%
     \setbpt@key{#1}{#5}%
     \@boolkeytrue%
  \fi%
  \if@boolkey%
  \else%
     \@latex@error{bptsetup: unknown value "#3" for the key "#2". Only "true" or "false" are permitted}{}%
  \fi%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% \setbpt@key
% \setbpt@key[value1,value2]{key}{value}


\def\bpt@key@split#1=#2\end{\def\bpt@key{#1}\def\bpt@value{#2}}

\def\setbpt@key{\@ifnextchar[{\@setbpt@key}{\@setbpt@key[]}}

\if@specialtoaux
  \let\auxspecial\@gobble
  \AtBeginDocument{\protected@write\@auxout{}{\string\let\string\auxspecial\string\@gobble}}
\fi
\def\@setbpt@key[#1]#2#3{%
  \ifx.#1.\else
    \def\setbpt@key@error{\@latex@error{Raktui "\bpt@key" neapibrezta reiksme "\bpt@value"}{}}
    \bpt@key@split#3\end
    \@for\@value:=#1\do{\ifx\@value\bpt@value \let\setbpt@key@error\relax\fi}
    \setbpt@key@error
  \fi
  \typeout{(bptsetup) setting: #3}%
  \if@specialtoaux
    \AtBeginDocument{\protected@write\@auxout{}{\string\auxspecial{vtex:settings.#2={#3}}}}% OTRS#15150
  \else
    \AtBeginDvi{\special{vtex:settings.#2={#3}}}%
  \fi
}

\def\bptsetup#1{\setkeys{bptsetup}{#1}}

\endinput
