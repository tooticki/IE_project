\NeedsTeXFormat{LaTeX2e}\ProvidesPackage{mosaicosPBC}\RequirePackage{tikz}\RequirePackage{ifthen}\RequirePackage{xparse}% Versión 1.1.1%%Contadores\newcounter{MosaicosPBCposx}%\newcounter{MosaicosPBCposy}%			%Estilos varios			\tikzstyle{BrT}=[fill=red!20!white]%			\tikzstyle{BrE}=[draw=red!80!black,very thick]%			%			\tikzstyle{CrT}=[fill=green!20!white]%			\tikzstyle{CrE}=[draw=green!80!black,very thick]%%Necesitaremos dos ficheros secundarios\newwrite\MosaicosPBCNodos%\newwrite\MosaicosPBCDivisionCr%%%%% Nl = Nueva Linea%% Va  = Cuadro Vacio%% Pl  = Placa%% Br  = Brazo%% Cr  = Cruce\DeclareDocumentEnvironment{mosaicoPBC}{O{}}%	{%		\begingroup			\pgfdeclarelayer{Relleno}			\pgfdeclarelayer{Teselas}			\pgfdeclarelayer{Borde}			\pgfsetlayers{Relleno,main,Borde,Teselas}			%Definiciones previas			%			%Inicializamos los contadores			\setcounter{MosaicosPBCposx}{0}%			\setcounter{MosaicosPBCposy}{0}%			%			\immediate\openout\MosaicosPBCNodos=\jobname-PBC-nodo.txt%			%			\immediate\openout\MosaicosPBCDivisionCr=\jobname-PBC-Cr.txt%			%			%			%Definimos los comandos que se podrán usar			%			%\Pl = Placa			\NewDocumentCommand\Pl{G{1}}%				{%					\begin{pgfonlayer}{Teselas}						\draw (\value{MosaicosPBCposx},\value{MosaicosPBCposy})							rectangle							(\value{MosaicosPBCposx} + ##1, \value{MosaicosPBCposy} + ##1);					\end{pgfonlayer}					\addtocounter{MosaicosPBCposx}{##1}%				}%			%			%\Va = Espcio vacio			\NewDocumentCommand\Va{G{1}}{ \addtocounter{MosaicosPBCposx}{##1} }%			%			%\Na = Nueva linea			\NewDocumentCommand\Nl{G{1}}%				{\addtocounter{MosaicosPBCposy}{##1}\setcounter{MosaicosPBCposx}{0}}%			%			%\Br = Brazo			\NewDocumentCommand\Br{mG{1}G{1}}%				{%					%Dibujamos el cuadrado					\begin{pgfonlayer}{Teselas}										\draw (\value{MosaicosPBCposx}, \value{MosaicosPBCposy})							rectangle							(\value{MosaicosPBCposx}+##2, \value{MosaicosPBCposy}+##3);%					\end{pgfonlayer}					%Dibujamos el relleno					\begin{pgfonlayer}{Relleno}										\fill[BrT] (\value{MosaicosPBCposx}, \value{MosaicosPBCposy})							rectangle							(\value{MosaicosPBCposx}+##2, \value{MosaicosPBCposy}+##3);%					\end{pgfonlayer}					%					\ifthenelse{\equal{##1}{-}}{%Si es brazo horizontal						%Dibujamos el brazo						\begin{pgfonlayer}{Borde}							\draw[BrE] (\value{MosaicosPBCposx}, \value{MosaicosPBCposy} + .5*##3)										-- (\value{MosaicosPBCposx} + ##2, \value{MosaicosPBCposy} + .5*##3);						\end{pgfonlayer}						%														% Escribimos los nodos a fichero						\count8 = \value{MosaicosPBCposx} % 2*posx						\multiply\count8 by 2%						%						\count9 = \value{MosaicosPBCposy} % 2*posy + ##3						\multiply\count9 by 2%						\advance\count9 by ##3%						%						\immediate\write\MosaicosPBCNodos{							\string\pgfkeyssetvalue\string{mosaicoPBC/\number\count8-\number\count9\string}\string{.\string}						}						%						\count8 = \value{MosaicosPBCposx} % 2*(posx ##2)						\advance\count8 by ##2%						\multiply\count8 by 2%						%						\immediate\write\MosaicosPBCNodos{							\string\pgfkeyssetvalue\string{mosaicoPBC/\number\count8-\number\count9\string}\string{.\string}						}					}{%Si es brazo vertical						%Dibujamos el brazo						\begin{pgfonlayer}{Borde}							\draw[BrE] (\value{MosaicosPBCposx} + .5*##2, \value{MosaicosPBCposy})										-- (\value{MosaicosPBCposx} + .5*##2, \value{MosaicosPBCposy} + ##3);						\end{pgfonlayer}						%						% Escribimos los nodos a fichero						\count8 = \value{MosaicosPBCposx} % 2*posx + ##2						\multiply\count8 by 2%						\advance\count8 by ##2%						%						\count9 = \value{MosaicosPBCposy} % 2*posy						\multiply\count9 by 2%						%						\immediate\write\MosaicosPBCNodos{							\string\pgfkeyssetvalue\string{mosaicoPBC/\number\count8-\number\count9\string}\string{.\string}						}						%						\count9 = \value{MosaicosPBCposy} % 2*(posx ##3)						\advance\count9 by ##3						\multiply\count9 by 2						%						\immediate\write\MosaicosPBCNodos{							\string\pgfkeyssetvalue\string{mosaicoPBC/\number\count8-\number\count9\string}\string{.\string}						}						%					}					%					%Avanzamos los suficientes					\addtocounter{MosaicosPBCposx}{##2}%				}%				%				%\Cr = Cruce				\NewDocumentCommand\Cr{G{1}G{1}}%				{					%dibujamos el cruce					\begin{pgfonlayer}{Teselas}						\draw (\value{MosaicosPBCposx},\value{MosaicosPBCposy}) rectangle								 (\value{MosaicosPBCposx}+##1,\value{MosaicosPBCposy}+##2);					\end{pgfonlayer}					\begin{pgfonlayer}{Relleno}						\fill[CrT] (\value{MosaicosPBCposx},\value{MosaicosPBCposy}) rectangle											 (\value{MosaicosPBCposx}+##1,\value{MosaicosPBCposy}+##2);					\end{pgfonlayer}						%					%Calculamos el vértice					\count4 = \value{MosaicosPBCposx} %2*posx + ##1					\multiply\count4 by 2%					\advance\count4 by ##1%					%					\count5 = \value{MosaicosPBCposy} %2*posy + ##2					\multiply\count5 by 2%					\advance\count5 by ##2%					%					%Escribimos en fichero										\count8 = \value{MosaicosPBCposy} % 2*posy					\multiply\count8 by 2%					%					\count9 = \value{MosaicosPBCposy} % 2*(posy + ##2)					\advance\count9 by ##2%					\multiply\count9 by 2%					%						\foreach \x in {0,...,##1}{%						\count7 = \value{MosaicosPBCposx} % 2*(posx + x)						\advance\count7 by \x%						\multiply\count7 by 2%						%						%Las posiciones enteras							\immediate\write\MosaicosPBCDivisionCr{%							\string\pgfkeysifdefined								\string{mosaicoPBC/\number\count7-\number\count8\string}								\string{\string\draw[CrE]									(\number\count4/2,\number\count5/2) -- 									(\number\count7/2,\number\count8/2);								\string}\string{\string}						}%						\immediate\write\MosaicosPBCDivisionCr{%							\string\pgfkeysifdefined								\string{mosaicoPBC/\number\count7-\number\count9\string}								\string{\string\draw[CrE]									(\number\count4/2,\number\count5/2) -- 									(\number\count7/2,\number\count9/2);								\string}\string{\string}						}%						%						%Las posiciones medias						\ifnum\x<##1							\advance\count7 by 1							\immediate\write\MosaicosPBCDivisionCr{%								\string\pgfkeysifdefined									\string{mosaicoPBC/\number\count7-\number\count8\string}									\string{\string\draw[CrE]										(\number\count4/2,\number\count5/2) -- 										(\number\count7/2,\number\count8/2);									\string}\string{\string}							}%							\immediate\write\MosaicosPBCDivisionCr{%								\string\pgfkeysifdefined									\string{mosaicoPBC/\number\count7-\number\count9\string}									\string{\string\draw[CrE]										(\number\count4/2,\number\count5/2) -- 										(\number\count7/2,\number\count9/2);									\string}\string{\string}							}%						\fi					}%					%					\count8 = \value{MosaicosPBCposx} % 2*posx					\multiply\count8 by 2%					%					\count9 = \value{MosaicosPBCposx} % 2*(posx + ##1)					\advance\count9 by ##1%					\multiply\count9 by 2%					%					\foreach \y in {0,...,##2}{%						\count7 = \value{MosaicosPBCposy} % 2*(posy + y)						\advance\count7 by \y%						\multiply\count7 by 2%						%						%Las posiciones enteras							\immediate\write\MosaicosPBCDivisionCr{%							\string\pgfkeysifdefined								\string{mosaicoPBC/\number\count8-\number\count7\string}								\string{\string\draw[CrE]									(\number\count4/2,\number\count5/2) -- 									(\number\count8/2,\number\count7/2);								\string}\string{\string}						}%						\immediate\write\MosaicosPBCDivisionCr{%							\string\pgfkeysifdefined								\string{mosaicoPBC/\number\count9-\number\count7\string}								\string{\string\draw[CrE]									(\number\count4/2,\number\count5/2) -- 									(\number\count9/2,\number\count7/2);								\string}\string{\string}						}%						%						%Las posiciones medias						\ifnum\y<##2							\advance\count7 by 1							\immediate\write\MosaicosPBCDivisionCr{%								\string\pgfkeysifdefined									\string{mosaicoPBC/\number\count8-\number\count7\string}									\string{\string\draw[CrE]										(\number\count4/2,\number\count5/2) -- 										(\number\count8/2,\number\count7/2);									\string}\string{\string}							}%							\immediate\write\MosaicosPBCDivisionCr{%								\string\pgfkeysifdefined									\string{mosaicoPBC/\number\count9-\number\count7\string}									\string{\string\draw[CrE]										(\number\count4/2,\number\count5/2) -- 										(\number\count9/2,\number\count7/2);									\string}\string{\string}							}%						\fi					}%					%					%Avanzamos en X					\addtocounter{MosaicosPBCposx}{##1}%				}%			\begin{tikzpicture}[yscale=-1,#1]	}%	{%			\immediate\closeout\MosaicosPBCNodos%			\immediate\closeout\MosaicosPBCDivisionCr%						\input{\jobname-PBC-nodo.txt}			\begin{pgfonlayer}{Borde}				\input{\jobname-PBC-Cr.txt}			\end{pgfonlayer}			\end{tikzpicture}%		\endgroup%	}